<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bootstrapping with weights using rTPC â€¢ rTPC</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Bootstrapping with weights using rTPC">
<meta property="og:description" content="rTPC">
<meta property="og:image" content="/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-74093873-3"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-74093873-3');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">rTPC</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/rTPC.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li class="divider">
    <li class="dropdown-header">Fitting a single curve</li>
    <li>
      <a href="../articles/fit_many_models.html">Fitting many models with rTPC</a>
    </li>
    <li>
      <a href="../articles/model_weighting.html">Model weighting with rTPC</a>
    </li>
    <li>
      <a href="../articles/model_averaging_selection.html">Model selection and model averaging with rTPC</a>
    </li>
    <li>
      <a href="../articles/bootstrapping_models.html">Bootstrapping using rTPC</a>
    </li>
    <li>
      <a href="../articles/weighted_bootstrapping.html">Bootstrapping with weights using rTPC</a>
    </li>
    <li class="divider">
    <li class="dropdown-header">Fitting many curves</li>
    <li>
      <a href="../articles/fit_many_curves.html">Fitting many curves using rTPC</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/padpadpadpad/rTPC/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="weighted_bootstrapping_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Bootstrapping with weights using rTPC</h1>
                        <h4 class="author">Daniel Padfield</h4>
            
            <h4 class="date">2020-09-04</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/padpadpadpad/rTPC/blob/master/vignettes/weighted_bootstrapping.Rmd"><code>vignettes/weighted_bootstrapping.Rmd</code></a></small>
      <div class="hidden name"><code>weighted_bootstrapping.Rmd</code></div>

    </div>

    
    
<div id="a-brief-example-of-how-bootstrapping-can-be-implemented-alongside-model-weighting-to-account-for-model-uncertainty-alongside-measurement-uncertainty-" class="section level4">
<h4 class="hasAnchor">
<a href="#a-brief-example-of-how-bootstrapping-can-be-implemented-alongside-model-weighting-to-account-for-model-uncertainty-alongside-measurement-uncertainty-" class="anchor"></a>A brief example of how bootstrapping can be implemented alongside model weighting to account for model uncertainty alongside measurement uncertainty.</h4>
<hr>
</div>
<div id="things-to-consider" class="section level2">
<h2 class="hasAnchor">
<a href="#things-to-consider" class="anchor"></a>Things to consider</h2>
<ul>
<li>Think carefully at about your level of replication</li>
<li>Bootstrapping weighted regression models only makes sense using case resampling, not residual resampling</li>
<li>See <code><a href="../articles/bootstrapping_models.html">vignette("bootstrapping_models")</a></code> for examples of bootstrapping without weights</li>
<li>The outcomes of the different approaches outlined here are likely to change based on the data and the model used. Use this methods with caution and think critically about their output</li>
</ul>
<hr>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="co"># load packages</span>
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">boot</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">rTPC</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">nls.multstart</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">broom</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">tidyverse</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">patchwork</span>)</pre></body></html></div>
<p>When doing model weighting, as implemented in <code>vignette(model_weighting)</code>, the standard deviation of each point that can be used to account for measurement uncertainty and change the model fit of the thermal performance curve. However, how this approach can be combined with bootstrapping is unclear. Here, we provide three possible approaches to bootstrapping when using weighted non-linear regression to fit thermal performance curves. They all use the data re-sampling.</p>
<ol style="list-style-type: decimal">
<li>Re-sample each data point with a probability proportional to its weight and do weighted non-linear least squares regression on each bootstrapped dataset</li>
<li>Re-sample each data point irrespective of its weight, but use weighted non-linear least squares regression on each bootstrapped dataset</li>
<li>Re-sample each data point with a probability proportional to its weight and use standard non-linear least regression on each bootstrapped dataset</li>
</ol>
<p>We will demonstrate these approaches using the example in <code><a href="../articles/model_weighting.html">vignette('model_weighting')</a></code>. This vignette uses the example dataset contained within <strong>rTPC</strong> - a dataset of 60 TPCs of respiration and photosynthesis of the aquatic algae, <em>Chlorella vulgaris</em>. Instead of plotting a single curve, we average over the biological replicates, <code>rep</code>, within a growth temperature (here photosynthesis from cultures adapted to 33 ÂºC), to get mean rate values at each assay temperature and their standard deviation. These are then plotted using <strong>ggplot2</strong>. Instead of fitting <strong>kamykowski_1985</strong>, we will instead fit <strong>lactin2_1995</strong> in this example.</p>
<p>The use of weights in <strong>Boot()</strong> is currently not supported, so I shall demonstrate how to write a very simple function to pass directly to <strong>boot()</strong> for the bootstrapping approaches.</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="co"># get curve data</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span>(<span class="st">"chlorella_tpc"</span>)

<span class="no">d_ave</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">chlorella_tpc</span>, <span class="no">process</span> <span class="kw">==</span> <span class="st">'adaptation'</span>, <span class="no">growth_temp</span> <span class="kw">==</span> <span class="fl">33</span>, <span class="no">flux</span> <span class="kw">==</span> <span class="st">'photosynthesis'</span>) <span class="kw">%&gt;%</span>
  <span class="fu">group_by</span>(<span class="no">temp</span>, <span class="no">flux</span>) <span class="kw">%&gt;%</span>
  <span class="fu">summarise</span>(<span class="no">.</span>, <span class="kw">sd</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span>(<span class="no">rate</span>),
            <span class="kw">ave_rate</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="no">rate</span>)) <span class="kw">%&gt;%</span>
  <span class="fu">ungroup</span>()
<span class="co">#&gt; `summarise()` regrouping output by 'temp' (override with `.groups` argument)</span>

<span class="no">d_fit</span> <span class="kw">&lt;-</span> <span class="fu">nest</span>(<span class="no">d_ave</span>, <span class="kw">data</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">temp</span>, <span class="no">ave_rate</span>, <span class="no">sd</span>)) <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="kw">weighted</span> <span class="kw">=</span> <span class="fu">map</span>(<span class="no">data</span>, ~<span class="fu"><a href="https://rdrr.io/pkg/nls.multstart/man/nls_multstart.html">nls_multstart</a></span>(<span class="no">ave_rate</span>~<span class="fu"><a href="../reference/lactin2_1995.html">lactin2_1995</a></span>(<span class="kw">temp</span> <span class="kw">=</span> <span class="no">temp</span>, <span class="no">a</span>, <span class="no">b</span>, <span class="no">tmax</span>, <span class="no">delta_t</span>),
                        <span class="kw">data</span> <span class="kw">=</span> <span class="no">.x</span>,
                        <span class="kw">iter</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">3</span>,<span class="fl">3</span>,<span class="fl">3</span>,<span class="fl">3</span>),
                        <span class="kw">start_lower</span> <span class="kw">=</span> <span class="fu"><a href="../reference/get_start_vals.html">get_start_vals</a></span>(<span class="no">.x</span>$<span class="no">temp</span>, <span class="no">.x</span>$<span class="no">ave_rate</span>, <span class="kw">model_name</span> <span class="kw">=</span> <span class="st">'lactin2_1995'</span>) - <span class="fl">10</span>,
                        <span class="kw">start_upper</span> <span class="kw">=</span> <span class="fu"><a href="../reference/get_start_vals.html">get_start_vals</a></span>(<span class="no">.x</span>$<span class="no">temp</span>, <span class="no">.x</span>$<span class="no">ave_rate</span>, <span class="kw">model_name</span> <span class="kw">=</span> <span class="st">'lactin2_1995'</span>) + <span class="fl">10</span>,
                        <span class="kw">lower</span> <span class="kw">=</span> <span class="fu"><a href="../reference/get_lower_lims.html">get_lower_lims</a></span>(<span class="no">.x</span>$<span class="no">temp</span>, <span class="no">.x</span>$<span class="no">ave_rate</span>, <span class="kw">model_name</span> <span class="kw">=</span> <span class="st">'lactin2_1995'</span>),
                        <span class="kw">upper</span> <span class="kw">=</span> <span class="fu"><a href="../reference/get_upper_lims.html">get_upper_lims</a></span>(<span class="no">.x</span>$<span class="no">temp</span>, <span class="no">.x</span>$<span class="no">ave_rate</span>, <span class="kw">model_name</span> <span class="kw">=</span> <span class="st">'lactin2_1995'</span>),
                        <span class="kw">supp_errors</span> <span class="kw">=</span> <span class="st">'Y'</span>,
                        <span class="kw">convergence_count</span> <span class="kw">=</span> <span class="fl">FALSE</span>,
                        <span class="co"># include weights here!</span>
                        <span class="kw">modelweights</span> <span class="kw">=</span> <span class="fl">1</span>/<span class="no">sd</span>)))

<span class="co"># get predictions using augment</span>
<span class="no">newdata</span> <span class="kw">&lt;-</span> <span class="fu">tibble</span>(<span class="kw">temp</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="no">d_ave</span>$<span class="no">temp</span>), <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="no">d_ave</span>$<span class="no">temp</span>), <span class="kw">length.out</span> <span class="kw">=</span> <span class="fl">100</span>))
<span class="no">d_preds</span> <span class="kw">&lt;-</span> <span class="no">d_fit</span> <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="no">.</span>, <span class="kw">preds</span> <span class="kw">=</span> <span class="fu">map</span>(<span class="no">weighted</span>, <span class="no">augment</span>, <span class="kw">newdata</span> <span class="kw">=</span> <span class="no">newdata</span>)) <span class="kw">%&gt;%</span>
  <span class="fu">select</span>(-<span class="no">weighted</span>) <span class="kw">%&gt;%</span>
  <span class="fu">unnest</span>(<span class="no">preds</span>)

<span class="co"># plot</span>
<span class="fu">ggplot</span>() +
  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="no">temp</span>, <span class="no">.fitted</span>), <span class="no">d_preds</span>) +
  <span class="fu">geom_linerange</span>(<span class="fu">aes</span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">temp</span>, <span class="kw">ymin</span> <span class="kw">=</span> <span class="no">ave_rate</span> - <span class="no">sd</span>, <span class="kw">ymax</span> <span class="kw">=</span> <span class="no">ave_rate</span> + <span class="no">sd</span>), <span class="no">d_ave</span>) +
  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="no">temp</span>, <span class="no">ave_rate</span>), <span class="no">d_ave</span>, <span class="kw">size</span> <span class="kw">=</span> <span class="fl">2</span>, <span class="kw">shape</span> <span class="kw">=</span> <span class="fl">21</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="st">'green4'</span>) +
  <span class="fu">theme_bw</span>(<span class="kw">base_size</span> <span class="kw">=</span> <span class="fl">12</span>) +
  <span class="fu">theme</span>(<span class="kw">legend.position</span> <span class="kw">=</span> <span class="st">'none'</span>,
        <span class="kw">strip.text</span> <span class="kw">=</span> <span class="fu">element_text</span>(<span class="kw">hjust</span> <span class="kw">=</span> <span class="fl">0</span>),
        <span class="kw">strip.background</span> <span class="kw">=</span> <span class="fu">element_blank</span>()) +
  <span class="fu">labs</span>(<span class="kw">x</span> <span class="kw">=</span><span class="st">'Temperature (ÂºC)'</span>,
       <span class="kw">y</span> <span class="kw">=</span> <span class="st">'Metabolic rate'</span>,
       <span class="kw">title</span> <span class="kw">=</span> <span class="st">'Photosynthesis rates across temperatures'</span>) +
  <span class="fu">geom_hline</span>(<span class="fu">aes</span>(<span class="kw">yintercept</span> <span class="kw">=</span> <span class="fl">0</span>), <span class="kw">linetype</span> <span class="kw">=</span> <span class="fl">2</span>) +
  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.window.html">ylim</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(-<span class="fl">0.25</span>, <span class="fl">3.5</span>))</pre></body></html></div>
<p><img src="weighted_bootstrapping_files/figure-html/get_data-1.png" width="576" style="display: block; margin: auto;"></p>
<hr>
</div>
<div id="method-1-weighted-re-sampling-and-weighted-regression" class="section level1">
<h1 class="hasAnchor">
<a href="#method-1-weighted-re-sampling-and-weighted-regression" class="anchor"></a>Method 1: Weighted re-sampling and weighted regression</h1>
<p>This method re-samples new datasets where each point is sampled proportionally to its standard deviation. Weighted non-linear least squares regression is then implemented on each bootstrapped dataset.</p>
<p>First we will create the re-sampled bootstrapped datasets. We will use probability weighting for the re-sampled data according to the relative sizes of the standard deviation, <span class="math inline">\(\sigma\)</span>. We calculate this for each data point, <span class="math inline">\(i\)</span>, as</p>
<p><span class="math display">\[\frac{\frac{1}{\sigma_i}}{\sum\limits_{i=1}^{n}\frac{1}{\sigma_i}}\]</span> where <span class="math inline">\(n\)</span> is the number of data points. We can pass an argument to <strong>boot()</strong> for a vector of weights when resampling, so we will create this column and then feed it into our bootstrapping procedure. We will also refit the model using <strong>nlsLM()</strong> and their weights argument as in <code>vignette(bootstrapping_models)</code>. However, we will write our own function to pass to <strong>boot()</strong> as <strong>car::Boot()</strong> does not currently support non-linear least squares regression.</p>
<p>The function just refits a model to resampled data. I wrapped the <strong>nlsLM()</strong> call in a <strong>tryCatch()</strong> argument so <strong>boot()</strong> does not fail when one of the bootstraps fails to converge. In these instances, we just return <code>NA</code>, so we can calculate how many samples fail to converge. A TRUE/FALSE argument controls whether we want to do weighted non-linear least squares regression or not.</p>
<p>We can check to see whether the model is doing the correct thing on the actual data by asking it to refit the model on the original dataset.</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="co"># create column for probability of resampling</span>
<span class="no">d_ave</span> <span class="kw">&lt;-</span> <span class="fu">mutate</span>(<span class="no">d_ave</span>, <span class="kw">inv_sd</span> <span class="kw">=</span> <span class="fl">1</span>/<span class="no">sd</span>,
                <span class="kw">prob</span> <span class="kw">=</span> <span class="no">inv_sd</span>/<span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">inv_sd</span>))

<span class="co"># refit model using nlsLM</span>
<span class="no">fit_nlsLM</span> <span class="kw">&lt;-</span> <span class="kw pkg">minpack.lm</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/minpack.lm/man/nlsLM.html">nlsLM</a></span>(<span class="no">ave_rate</span>~<span class="fu"><a href="../reference/lactin2_1995.html">lactin2_1995</a></span>(<span class="kw">temp</span> <span class="kw">=</span> <span class="no">temp</span>, <span class="no">a</span>, <span class="no">b</span>, <span class="no">tmax</span>, <span class="no">delta_t</span>),
                        <span class="kw">data</span> <span class="kw">=</span> <span class="no">d_ave</span>,
                        <span class="kw">start</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span>(<span class="no">d_fit</span>$<span class="no">weighted</span><span class="kw">[[</span><span class="fl">1</span>]]),
                        <span class="kw">lower</span> <span class="kw">=</span> <span class="fu"><a href="../reference/get_lower_lims.html">get_lower_lims</a></span>(<span class="no">d_ave</span>$<span class="no">temp</span>, <span class="no">d_ave</span>$<span class="no">ave_rate</span>, <span class="kw">model_name</span> <span class="kw">=</span> <span class="st">'lactin2_1995'</span>),
                        <span class="kw">upper</span> <span class="kw">=</span> <span class="fu"><a href="../reference/get_upper_lims.html">get_upper_lims</a></span>(<span class="no">d_ave</span>$<span class="no">temp</span>, <span class="no">d_ave</span>$<span class="no">ave_rate</span>, <span class="kw">model_name</span> <span class="kw">=</span> <span class="st">'lactin2_1995'</span>),
                        <span class="kw">weights</span> <span class="kw">=</span> <span class="fl">1</span>/<span class="no">sd</span>)

<span class="co"># write function to pass to boot</span>
<span class="co"># doing weighted non-linear least squares regression</span>
<span class="no">boot_nlsLM</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">sample_data</span>, <span class="no">indices</span>, <span class="no">start_vals</span>, <span class="no">weighted_nls</span> <span class="kw">=</span> <span class="fl">TRUE</span>){

  <span class="co"># create subsampled data</span>
  <span class="no">temp_data</span> <span class="kw">&lt;-</span> <span class="no">sample_data</span>[<span class="no">indices</span>, ]

  <span class="no">model</span> <span class="kw">=</span> <span class="kw">NULL</span>
  <span class="no">output</span> <span class="kw">=</span> <span class="kw">NULL</span>

  <span class="co"># re run model</span>
  <span class="kw">if</span>(<span class="fu"><a href="https://rdrr.io/r/base/Logic.html">isTRUE</a></span>(<span class="no">weighted_nls</span>)){
    <span class="no">model</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/conditions.html">tryCatch</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/warning.html">suppressWarnings</a></span>(<span class="kw pkg">minpack.lm</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/minpack.lm/man/nlsLM.html">nlsLM</a></span>(<span class="no">ave_rate</span>~<span class="fu"><a href="../reference/lactin2_1995.html">lactin2_1995</a></span>(<span class="kw">temp</span> <span class="kw">=</span> <span class="no">temp</span>, <span class="no">a</span>, <span class="no">b</span>, <span class="no">tmax</span>, <span class="no">delta_t</span>),
                        <span class="kw">data</span> <span class="kw">=</span> <span class="no">temp_data</span>,
                        <span class="kw">start</span> <span class="kw">=</span> <span class="no">start_vals</span>,
                        <span class="kw">lower</span> <span class="kw">=</span> <span class="fu"><a href="../reference/get_lower_lims.html">get_lower_lims</a></span>(<span class="no">temp_data</span>$<span class="no">temp</span>, <span class="no">temp_data</span>$<span class="no">ave_rate</span>, <span class="kw">model_name</span> <span class="kw">=</span> <span class="st">'lactin2_1995'</span>),
                        <span class="kw">upper</span> <span class="kw">=</span> <span class="fu"><a href="../reference/get_upper_lims.html">get_upper_lims</a></span>(<span class="no">temp_data</span>$<span class="no">temp</span>, <span class="no">temp_data</span>$<span class="no">ave_rate</span>, <span class="kw">model_name</span> <span class="kw">=</span> <span class="st">'lactin2_1995'</span>),
                        <span class="kw">weights</span> <span class="kw">=</span> <span class="fl">1</span>/<span class="no">sd</span>)),
               <span class="kw">error</span> <span class="kw">=</span> <span class="kw">function</span>(<span class="no">e</span>) <span class="kw">NULL</span>)
  }

  <span class="co"># re run model</span>
  <span class="kw">if</span>(<span class="fu"><a href="https://rdrr.io/r/base/Logic.html">isFALSE</a></span>(<span class="no">weighted_nls</span>)){
    <span class="no">model</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/conditions.html">tryCatch</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/warning.html">suppressWarnings</a></span>(<span class="kw pkg">minpack.lm</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/minpack.lm/man/nlsLM.html">nlsLM</a></span>(<span class="no">ave_rate</span>~<span class="fu"><a href="../reference/lactin2_1995.html">lactin2_1995</a></span>(<span class="kw">temp</span> <span class="kw">=</span> <span class="no">temp</span>, <span class="no">a</span>, <span class="no">b</span>, <span class="no">tmax</span>, <span class="no">delta_t</span>),
                        <span class="kw">data</span> <span class="kw">=</span> <span class="no">temp_data</span>,
                        <span class="kw">start</span> <span class="kw">=</span> <span class="no">start_vals</span>,
                        <span class="kw">lower</span> <span class="kw">=</span> <span class="fu"><a href="../reference/get_lower_lims.html">get_lower_lims</a></span>(<span class="no">temp_data</span>$<span class="no">temp</span>, <span class="no">temp_data</span>$<span class="no">ave_rate</span>, <span class="kw">model_name</span> <span class="kw">=</span> <span class="st">'lactin2_1995'</span>),
                        <span class="kw">upper</span> <span class="kw">=</span> <span class="fu"><a href="../reference/get_upper_lims.html">get_upper_lims</a></span>(<span class="no">temp_data</span>$<span class="no">temp</span>, <span class="no">temp_data</span>$<span class="no">ave_rate</span>, <span class="kw">model_name</span> <span class="kw">=</span> <span class="st">'lactin2_1995'</span>))),
               <span class="kw">error</span> <span class="kw">=</span> <span class="kw">function</span>(<span class="no">e</span>) <span class="kw">NULL</span>)
  }

  <span class="kw">if</span>(<span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span>(<span class="no">model</span>)){
    <span class="no">output</span> <span class="kw">&lt;-</span> <span class="no">start_vals</span>
    <span class="no">output</span>[<span class="fl">1</span>:<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">output</span>)] <span class="kw">&lt;-</span> <span class="fl">NA</span>
    }

  <span class="kw">if</span>(!<span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span>(<span class="no">model</span>)){
    <span class="no">output</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span>(<span class="no">model</span>)
    }

  <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="no">output</span>)
}

<span class="co"># check to see it returns the same thing on the original data</span>
<span class="fu">boot_nlsLM</span>(<span class="no">d_ave</span>, <span class="fl">1</span>:<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">d_ave</span>), <span class="kw">start_vals</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span>(<span class="no">fit_nlsLM</span>), <span class="kw">weighted_nls</span> <span class="kw">=</span> <span class="fl">TRUE</span>)
<span class="co">#&gt;           a           b        tmax     delta_t </span>
<span class="co">#&gt;  0.03539109 -1.52100117 47.20966961  2.60222769</span>
<span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span>(<span class="no">fit_nlsLM</span>)
<span class="co">#&gt;           a           b        tmax     delta_t </span>
<span class="co">#&gt;  0.03539109 -1.52100117 47.20966961  2.60222769</span>
<span class="co"># yep this seems to work</span></pre></body></html></div>
<p>The results are identical! We will use <strong>boot()</strong> to do the weighted case resampling bootstrap using weighted non-linear least squares regression. We include a <code>weights</code> argument to <strong>boot()</strong> to allow weighted resampling (the smaller the standard deviation of the point, the more likely it will be resampled). We can then create model predictions for each bootstrap and confidence intervals of model predictions using the methods implemented in <code>vignette(bootstrapping_models)</code></p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="co"># bootstrap using weighted case resampling</span>
<span class="no">boot1</span> <span class="kw">&lt;-</span> <span class="kw pkg">boot</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/boot/man/boot.html">boot</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">d_ave</span>, <span class="kw">statistic</span> <span class="kw">=</span> <span class="no">boot_nlsLM</span>, <span class="kw">R</span> <span class="kw">=</span> <span class="fl">999</span>, <span class="kw">weights</span> <span class="kw">=</span> <span class="no">d_ave</span>$<span class="no">prob</span>, <span class="kw">start_vals</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span>(<span class="no">fit_nlsLM</span>), <span class="kw">weighted_nls</span> <span class="kw">=</span> <span class="fl">TRUE</span>)
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">boot1</span>$<span class="no">t</span>) <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span>(<span class="no">fit_nlsLM</span>))

<span class="co"># check how many samples converged</span>
<span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(!<span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="no">boot1</span>$<span class="no">t</span>))/<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">boot1</span>$<span class="no">t</span>) * <span class="fl">100</span>
<span class="co">#&gt; [1] 53.45345</span>

<span class="co"># predict over new data</span>
<span class="no">boot1_preds</span> <span class="kw">&lt;-</span> <span class="no">boot1</span>$<span class="no">t</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu">drop_na</span>() <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="kw">iter</span> <span class="kw">=</span> <span class="fl">1</span>:<span class="fu">n</span>()) <span class="kw">%&gt;%</span>
  <span class="fu">group_by_all</span>() <span class="kw">%&gt;%</span>
  <span class="fu">do</span>(<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="kw">temp</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="no">d_ave</span>$<span class="no">temp</span>), <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="no">d_ave</span>$<span class="no">temp</span>), <span class="kw">length.out</span> <span class="kw">=</span> <span class="fl">100</span>))) <span class="kw">%&gt;%</span>
  <span class="fu">ungroup</span>() <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="kw">pred</span> <span class="kw">=</span> <span class="fu"><a href="../reference/lactin2_1995.html">lactin2_1995</a></span>(<span class="no">temp</span>, <span class="no">a</span>, <span class="no">b</span>, <span class="no">tmax</span>, <span class="no">delta_t</span>))

<span class="co"># calculate bootstrapped confidence intervals</span>
<span class="no">boot1_conf_preds</span> <span class="kw">&lt;-</span> <span class="fu">group_by</span>(<span class="no">boot1_preds</span>, <span class="no">temp</span>) <span class="kw">%&gt;%</span>
  <span class="fu">summarise</span>(<span class="kw">conf_lower</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span>(<span class="no">pred</span>, <span class="fl">0.025</span>),
            <span class="kw">conf_upper</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span>(<span class="no">pred</span>, <span class="fl">0.975</span>),
            <span class="kw">.groups</span> <span class="kw">=</span> <span class="st">'drop'</span>)</pre></body></html></div>
<p>We can then plot these predictions using <strong>ggplot2</strong>.</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="co"># plot bootstrapped CIs</span>
<span class="no">p1</span> <span class="kw">&lt;-</span> <span class="fu">ggplot</span>() +
  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="no">temp</span>, <span class="no">.fitted</span>), <span class="no">d_preds</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="st">'black'</span>) +
  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="no">temp</span>, <span class="kw">ymin</span> <span class="kw">=</span> <span class="no">conf_lower</span>, <span class="kw">ymax</span> <span class="kw">=</span> <span class="no">conf_upper</span>), <span class="no">boot1_conf_preds</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="st">'black'</span>, <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.3</span>) +
  <span class="fu">geom_linerange</span>(<span class="fu">aes</span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">temp</span>, <span class="kw">ymin</span> <span class="kw">=</span> <span class="no">ave_rate</span> - <span class="no">sd</span>, <span class="kw">ymax</span> <span class="kw">=</span> <span class="no">ave_rate</span> + <span class="no">sd</span>), <span class="no">d_ave</span>) +
  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="no">temp</span>, <span class="no">ave_rate</span>), <span class="no">d_ave</span>, <span class="kw">size</span> <span class="kw">=</span> <span class="fl">2</span>, <span class="kw">shape</span> <span class="kw">=</span> <span class="fl">21</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="st">'green4'</span>) +
  <span class="fu">theme_bw</span>(<span class="kw">base_size</span> <span class="kw">=</span> <span class="fl">10</span>) +
  <span class="fu">theme</span>(<span class="kw">legend.position</span> <span class="kw">=</span> <span class="st">'none'</span>,
        <span class="kw">strip.text</span> <span class="kw">=</span> <span class="fu">element_text</span>(<span class="kw">hjust</span> <span class="kw">=</span> <span class="fl">0</span>),
        <span class="kw">strip.background</span> <span class="kw">=</span> <span class="fu">element_blank</span>()) +
  <span class="fu">labs</span>(<span class="kw">x</span> <span class="kw">=</span><span class="st">'Temperature (ÂºC)'</span>,
       <span class="kw">y</span> <span class="kw">=</span> <span class="st">'Metabolic rate'</span>,
       <span class="kw">title</span> <span class="kw">=</span> <span class="st">'Photosynthesis rates across temperatures'</span>) +
  <span class="fu">geom_hline</span>(<span class="fu">aes</span>(<span class="kw">yintercept</span> <span class="kw">=</span> <span class="fl">0</span>), <span class="kw">linetype</span> <span class="kw">=</span> <span class="fl">2</span>) +
  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.window.html">ylim</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(-<span class="fl">1</span>, <span class="fl">3.5</span>))

<span class="co"># plot bootstrapped predictions</span>
<span class="no">p2</span> <span class="kw">&lt;-</span> <span class="fu">ggplot</span>() +
  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="no">temp</span>, <span class="no">.fitted</span>), <span class="no">d_preds</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="st">'black'</span>) +
  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="no">temp</span>, <span class="no">pred</span>, <span class="kw">group</span> <span class="kw">=</span> <span class="no">iter</span>), <span class="no">boot1_preds</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="st">'black'</span>, <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.007</span>) +
  <span class="fu">geom_linerange</span>(<span class="fu">aes</span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">temp</span>, <span class="kw">ymin</span> <span class="kw">=</span> <span class="no">ave_rate</span> - <span class="no">sd</span>, <span class="kw">ymax</span> <span class="kw">=</span> <span class="no">ave_rate</span> + <span class="no">sd</span>), <span class="no">d_ave</span>) +
  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="no">temp</span>, <span class="no">ave_rate</span>), <span class="no">d_ave</span>, <span class="kw">size</span> <span class="kw">=</span> <span class="fl">2</span>, <span class="kw">shape</span> <span class="kw">=</span> <span class="fl">21</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="st">'green4'</span>) +
  <span class="fu">theme_bw</span>(<span class="kw">base_size</span> <span class="kw">=</span> <span class="fl">10</span>) +
  <span class="fu">theme</span>(<span class="kw">legend.position</span> <span class="kw">=</span> <span class="st">'none'</span>,
        <span class="kw">strip.text</span> <span class="kw">=</span> <span class="fu">element_text</span>(<span class="kw">hjust</span> <span class="kw">=</span> <span class="fl">0</span>),
        <span class="kw">strip.background</span> <span class="kw">=</span> <span class="fu">element_blank</span>()) +
  <span class="fu">labs</span>(<span class="kw">x</span> <span class="kw">=</span><span class="st">'Temperature (ÂºC)'</span>,
       <span class="kw">y</span> <span class="kw">=</span> <span class="st">'Metabolic rate'</span>,
       <span class="kw">title</span> <span class="kw">=</span> <span class="st">'Photosynthesis rates across temperatures'</span>) +
  <span class="fu">geom_hline</span>(<span class="fu">aes</span>(<span class="kw">yintercept</span> <span class="kw">=</span> <span class="fl">0</span>), <span class="kw">linetype</span> <span class="kw">=</span> <span class="fl">2</span>) +
  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.window.html">ylim</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(-<span class="fl">1</span>, <span class="fl">3.5</span>))

<span class="no">p1</span> + <span class="no">p2</span></pre></body></html></div>
<p><img src="weighted_bootstrapping_files/figure-html/bootstrap1_plot-1.png" width="768" style="display: block; margin: auto;"></p>
<hr>
</div>
<div id="method-2-unweighted-re-sampling-and-weighted-regression" class="section level1">
<h1 class="hasAnchor">
<a href="#method-2-unweighted-re-sampling-and-weighted-regression" class="anchor"></a>Method 2: Unweighted re-sampling and weighted regression</h1>
<p>This method resamples new datasets while ignoring the standard deviations of each point, but uses weighted regression on each resampled bootstrapped dataset. So this time we just omit the <code>weights</code> argument from the call to <strong>boot()</strong>.</p>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="co"># bootstrap using case resampling, but do weighted nls</span>
<span class="no">boot2</span> <span class="kw">&lt;-</span> <span class="kw pkg">boot</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/boot/man/boot.html">boot</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">d_ave</span>, <span class="kw">statistic</span> <span class="kw">=</span> <span class="no">boot_nlsLM</span>, <span class="kw">R</span> <span class="kw">=</span> <span class="fl">999</span>, <span class="kw">start_vals</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span>(<span class="no">fit_nlsLM</span>), <span class="kw">weighted_nls</span> <span class="kw">=</span> <span class="fl">TRUE</span>)
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">boot2</span>$<span class="no">t</span>) <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span>(<span class="no">fit_nlsLM</span>))

<span class="co"># check how many samples converged</span>
<span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(!<span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="no">boot2</span>$<span class="no">t</span>))/<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">boot2</span>$<span class="no">t</span>) * <span class="fl">100</span>
<span class="co">#&gt; [1] 68.16817</span>
<span class="co"># 53% - not fantastic: can always run more</span>

<span class="co"># predict over new data</span>
<span class="no">boot2_preds</span> <span class="kw">&lt;-</span> <span class="no">boot2</span>$<span class="no">t</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu">drop_na</span>() <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="kw">iter</span> <span class="kw">=</span> <span class="fl">1</span>:<span class="fu">n</span>()) <span class="kw">%&gt;%</span>
  <span class="fu">group_by_all</span>() <span class="kw">%&gt;%</span>
  <span class="fu">do</span>(<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="kw">temp</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="no">d_ave</span>$<span class="no">temp</span>), <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="no">d_ave</span>$<span class="no">temp</span>), <span class="kw">length.out</span> <span class="kw">=</span> <span class="fl">100</span>))) <span class="kw">%&gt;%</span>
  <span class="fu">ungroup</span>() <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="kw">pred</span> <span class="kw">=</span> <span class="fu"><a href="../reference/lactin2_1995.html">lactin2_1995</a></span>(<span class="no">temp</span>, <span class="no">a</span>, <span class="no">b</span>, <span class="no">tmax</span>, <span class="no">delta_t</span>))

<span class="co"># calculate bootstrapped confidence intervals</span>
<span class="no">boot2_conf_preds</span> <span class="kw">&lt;-</span> <span class="fu">group_by</span>(<span class="no">boot2_preds</span>, <span class="no">temp</span>) <span class="kw">%&gt;%</span>
  <span class="fu">summarise</span>(<span class="kw">conf_lower</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span>(<span class="no">pred</span>, <span class="fl">0.025</span>),
            <span class="kw">conf_upper</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span>(<span class="no">pred</span>, <span class="fl">0.975</span>),
            <span class="kw">.groups</span> <span class="kw">=</span> <span class="st">'drop'</span>)

<span class="co"># plot bootstrapped CIs</span>
<span class="no">p1</span> <span class="kw">&lt;-</span> <span class="fu">ggplot</span>() +
  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="no">temp</span>, <span class="no">.fitted</span>), <span class="no">d_preds</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="st">'black'</span>) +
  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="no">temp</span>, <span class="kw">ymin</span> <span class="kw">=</span> <span class="no">conf_lower</span>, <span class="kw">ymax</span> <span class="kw">=</span> <span class="no">conf_upper</span>), <span class="no">boot2_conf_preds</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="st">'black'</span>, <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.3</span>) +
  <span class="fu">geom_linerange</span>(<span class="fu">aes</span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">temp</span>, <span class="kw">ymin</span> <span class="kw">=</span> <span class="no">ave_rate</span> - <span class="no">sd</span>, <span class="kw">ymax</span> <span class="kw">=</span> <span class="no">ave_rate</span> + <span class="no">sd</span>), <span class="no">d_ave</span>) +
  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="no">temp</span>, <span class="no">ave_rate</span>), <span class="no">d_ave</span>, <span class="kw">size</span> <span class="kw">=</span> <span class="fl">2</span>, <span class="kw">shape</span> <span class="kw">=</span> <span class="fl">21</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="st">'green4'</span>) +
  <span class="fu">theme_bw</span>(<span class="kw">base_size</span> <span class="kw">=</span> <span class="fl">10</span>) +
  <span class="fu">theme</span>(<span class="kw">legend.position</span> <span class="kw">=</span> <span class="st">'none'</span>,
        <span class="kw">strip.text</span> <span class="kw">=</span> <span class="fu">element_text</span>(<span class="kw">hjust</span> <span class="kw">=</span> <span class="fl">0</span>),
        <span class="kw">strip.background</span> <span class="kw">=</span> <span class="fu">element_blank</span>()) +
  <span class="fu">labs</span>(<span class="kw">x</span> <span class="kw">=</span><span class="st">'Temperature (ÂºC)'</span>,
       <span class="kw">y</span> <span class="kw">=</span> <span class="st">'Metabolic rate'</span>,
       <span class="kw">title</span> <span class="kw">=</span> <span class="st">'Photosynthesis rates across temperatures'</span>) +
  <span class="fu">geom_hline</span>(<span class="fu">aes</span>(<span class="kw">yintercept</span> <span class="kw">=</span> <span class="fl">0</span>), <span class="kw">linetype</span> <span class="kw">=</span> <span class="fl">2</span>) +
  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.window.html">ylim</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(-<span class="fl">5</span>, <span class="fl">3.5</span>))

<span class="co"># plot bootstrapped predictions</span>
<span class="no">p2</span> <span class="kw">&lt;-</span> <span class="fu">ggplot</span>() +
  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="no">temp</span>, <span class="no">.fitted</span>), <span class="no">d_preds</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="st">'black'</span>) +
  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="no">temp</span>, <span class="no">pred</span>, <span class="kw">group</span> <span class="kw">=</span> <span class="no">iter</span>), <span class="no">boot2_preds</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="st">'black'</span>, <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.007</span>) +
  <span class="fu">geom_linerange</span>(<span class="fu">aes</span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">temp</span>, <span class="kw">ymin</span> <span class="kw">=</span> <span class="no">ave_rate</span> - <span class="no">sd</span>, <span class="kw">ymax</span> <span class="kw">=</span> <span class="no">ave_rate</span> + <span class="no">sd</span>), <span class="no">d_ave</span>) +
  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="no">temp</span>, <span class="no">ave_rate</span>), <span class="no">d_ave</span>, <span class="kw">size</span> <span class="kw">=</span> <span class="fl">2</span>, <span class="kw">shape</span> <span class="kw">=</span> <span class="fl">21</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="st">'green4'</span>) +
  <span class="fu">theme_bw</span>(<span class="kw">base_size</span> <span class="kw">=</span> <span class="fl">10</span>) +
  <span class="fu">theme</span>(<span class="kw">legend.position</span> <span class="kw">=</span> <span class="st">'none'</span>,
        <span class="kw">strip.text</span> <span class="kw">=</span> <span class="fu">element_text</span>(<span class="kw">hjust</span> <span class="kw">=</span> <span class="fl">0</span>),
        <span class="kw">strip.background</span> <span class="kw">=</span> <span class="fu">element_blank</span>()) +
  <span class="fu">labs</span>(<span class="kw">x</span> <span class="kw">=</span><span class="st">'Temperature (ÂºC)'</span>,
       <span class="kw">y</span> <span class="kw">=</span> <span class="st">'Metabolic rate'</span>,
       <span class="kw">title</span> <span class="kw">=</span> <span class="st">'Photosynthesis rates across temperatures'</span>) +
  <span class="fu">geom_hline</span>(<span class="fu">aes</span>(<span class="kw">yintercept</span> <span class="kw">=</span> <span class="fl">0</span>), <span class="kw">linetype</span> <span class="kw">=</span> <span class="fl">2</span>) +
  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.window.html">ylim</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(-<span class="fl">3</span>, <span class="fl">3.5</span>))

<span class="no">p1</span> + <span class="no">p2</span></pre></body></html></div>
<p><img src="weighted_bootstrapping_files/figure-html/bootstrap2-1.png" width="768" style="display: block; margin: auto;"> In this instance, the unweighted case resampling method gives really wide confidence intervals for the model predictions at high temperatures. When the 49 ÂºC temperature is not present in the resampled data, the curve fits very differently. This is likely a problem with most models that allow for negative rates, whereas those that do not may not have the problem as much because the mathematical formulation forces rates to always be positive.</p>
<hr>
</div>
<div id="method-3-weighted-re-sampling-and-standard-non-linear-least-squares-regression" class="section level1">
<h1 class="hasAnchor">
<a href="#method-3-weighted-re-sampling-and-standard-non-linear-least-squares-regression" class="anchor"></a>Method 3: Weighted re-sampling and standard non-linear least squares regression</h1>
<p>This method re-samples each data point with a probability proportional to its weight and use standard non-linear least regression on each bootstrapped dataset. We can do this easily by switched <code>weighted_nls</code> to <code>FALSE</code> inside our custom <strong>boot_nlsLM()</strong> function.</p>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="co"># bootstrap using weighted case resampling, do standard nls</span>
<span class="no">boot3</span> <span class="kw">&lt;-</span> <span class="kw pkg">boot</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/boot/man/boot.html">boot</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">d_ave</span>, <span class="kw">statistic</span> <span class="kw">=</span> <span class="no">boot_nlsLM</span>, <span class="kw">R</span> <span class="kw">=</span> <span class="fl">999</span>, <span class="kw">weights</span> <span class="kw">=</span> <span class="no">d_ave</span>$<span class="no">prob</span>, <span class="kw">start_vals</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span>(<span class="no">fit_nlsLM</span>), <span class="kw">weighted_nls</span> <span class="kw">=</span> <span class="fl">FALSE</span>)
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">boot3</span>$<span class="no">t</span>) <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span>(<span class="no">fit_nlsLM</span>))

<span class="co"># check how many samples converged</span>
<span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(!<span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="no">boot3</span>$<span class="no">t</span>))/<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">boot3</span>$<span class="no">t</span>) * <span class="fl">100</span>
<span class="co">#&gt; [1] 59.65966</span>
<span class="co"># 53% - not fantastic: can always run more</span>

<span class="co"># predict over new data</span>
<span class="no">boot3_preds</span> <span class="kw">&lt;-</span> <span class="no">boot3</span>$<span class="no">t</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu">drop_na</span>() <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="kw">iter</span> <span class="kw">=</span> <span class="fl">1</span>:<span class="fu">n</span>()) <span class="kw">%&gt;%</span>
  <span class="fu">group_by_all</span>() <span class="kw">%&gt;%</span>
  <span class="fu">do</span>(<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="kw">temp</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="no">d_ave</span>$<span class="no">temp</span>), <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="no">d_ave</span>$<span class="no">temp</span>), <span class="kw">length.out</span> <span class="kw">=</span> <span class="fl">100</span>))) <span class="kw">%&gt;%</span>
  <span class="fu">ungroup</span>() <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="kw">pred</span> <span class="kw">=</span> <span class="fu"><a href="../reference/lactin2_1995.html">lactin2_1995</a></span>(<span class="no">temp</span>, <span class="no">a</span>, <span class="no">b</span>, <span class="no">tmax</span>, <span class="no">delta_t</span>))

<span class="co"># calculate bootstrapped confidence intervals</span>
<span class="no">boot3_conf_preds</span> <span class="kw">&lt;-</span> <span class="fu">group_by</span>(<span class="no">boot3_preds</span>, <span class="no">temp</span>) <span class="kw">%&gt;%</span>
  <span class="fu">summarise</span>(<span class="kw">conf_lower</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span>(<span class="no">pred</span>, <span class="fl">0.025</span>),
            <span class="kw">conf_upper</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span>(<span class="no">pred</span>, <span class="fl">0.975</span>),
            <span class="kw">.groups</span> <span class="kw">=</span> <span class="st">'drop'</span>)

<span class="co"># plot bootstrapped CIs</span>
<span class="no">p1</span> <span class="kw">&lt;-</span> <span class="fu">ggplot</span>() +
  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="no">temp</span>, <span class="no">.fitted</span>), <span class="no">d_preds</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="st">'black'</span>) +
  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="no">temp</span>, <span class="kw">ymin</span> <span class="kw">=</span> <span class="no">conf_lower</span>, <span class="kw">ymax</span> <span class="kw">=</span> <span class="no">conf_upper</span>), <span class="no">boot3_conf_preds</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="st">'black'</span>, <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.3</span>) +
  <span class="fu">geom_linerange</span>(<span class="fu">aes</span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">temp</span>, <span class="kw">ymin</span> <span class="kw">=</span> <span class="no">ave_rate</span> - <span class="no">sd</span>, <span class="kw">ymax</span> <span class="kw">=</span> <span class="no">ave_rate</span> + <span class="no">sd</span>), <span class="no">d_ave</span>) +
  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="no">temp</span>, <span class="no">ave_rate</span>), <span class="no">d_ave</span>, <span class="kw">size</span> <span class="kw">=</span> <span class="fl">2</span>, <span class="kw">shape</span> <span class="kw">=</span> <span class="fl">21</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="st">'green4'</span>) +
  <span class="fu">theme_bw</span>(<span class="kw">base_size</span> <span class="kw">=</span> <span class="fl">10</span>) +
  <span class="fu">theme</span>(<span class="kw">legend.position</span> <span class="kw">=</span> <span class="st">'none'</span>,
        <span class="kw">strip.text</span> <span class="kw">=</span> <span class="fu">element_text</span>(<span class="kw">hjust</span> <span class="kw">=</span> <span class="fl">0</span>),
        <span class="kw">strip.background</span> <span class="kw">=</span> <span class="fu">element_blank</span>()) +
  <span class="fu">labs</span>(<span class="kw">x</span> <span class="kw">=</span><span class="st">'Temperature (ÂºC)'</span>,
       <span class="kw">y</span> <span class="kw">=</span> <span class="st">'Metabolic rate'</span>,
       <span class="kw">title</span> <span class="kw">=</span> <span class="st">'Photosynthesis rates across temperatures'</span>) +
  <span class="fu">geom_hline</span>(<span class="fu">aes</span>(<span class="kw">yintercept</span> <span class="kw">=</span> <span class="fl">0</span>), <span class="kw">linetype</span> <span class="kw">=</span> <span class="fl">2</span>) +
  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.window.html">ylim</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(-<span class="fl">5</span>, <span class="fl">3.5</span>))

<span class="co"># plot bootstrapped predictions</span>
<span class="no">p2</span> <span class="kw">&lt;-</span> <span class="fu">ggplot</span>() +
  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="no">temp</span>, <span class="no">.fitted</span>), <span class="no">d_preds</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="st">'black'</span>) +
  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="no">temp</span>, <span class="no">pred</span>, <span class="kw">group</span> <span class="kw">=</span> <span class="no">iter</span>), <span class="no">boot3_preds</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="st">'black'</span>, <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.007</span>) +
  <span class="fu">geom_linerange</span>(<span class="fu">aes</span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">temp</span>, <span class="kw">ymin</span> <span class="kw">=</span> <span class="no">ave_rate</span> - <span class="no">sd</span>, <span class="kw">ymax</span> <span class="kw">=</span> <span class="no">ave_rate</span> + <span class="no">sd</span>), <span class="no">d_ave</span>) +
  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="no">temp</span>, <span class="no">ave_rate</span>), <span class="no">d_ave</span>, <span class="kw">size</span> <span class="kw">=</span> <span class="fl">2</span>, <span class="kw">shape</span> <span class="kw">=</span> <span class="fl">21</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="st">'green4'</span>) +
  <span class="fu">theme_bw</span>(<span class="kw">base_size</span> <span class="kw">=</span> <span class="fl">10</span>) +
  <span class="fu">theme</span>(<span class="kw">legend.position</span> <span class="kw">=</span> <span class="st">'none'</span>,
        <span class="kw">strip.text</span> <span class="kw">=</span> <span class="fu">element_text</span>(<span class="kw">hjust</span> <span class="kw">=</span> <span class="fl">0</span>),
        <span class="kw">strip.background</span> <span class="kw">=</span> <span class="fu">element_blank</span>()) +
  <span class="fu">labs</span>(<span class="kw">x</span> <span class="kw">=</span><span class="st">'Temperature (ÂºC)'</span>,
       <span class="kw">y</span> <span class="kw">=</span> <span class="st">'Metabolic rate'</span>,
       <span class="kw">title</span> <span class="kw">=</span> <span class="st">'Photosynthesis rates across temperatures'</span>) +
  <span class="fu">geom_hline</span>(<span class="fu">aes</span>(<span class="kw">yintercept</span> <span class="kw">=</span> <span class="fl">0</span>), <span class="kw">linetype</span> <span class="kw">=</span> <span class="fl">2</span>) +
  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.window.html">ylim</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(-<span class="fl">3</span>, <span class="fl">3.5</span>))

<span class="no">p1</span> + <span class="no">p2</span></pre></body></html></div>
<p><img src="weighted_bootstrapping_files/figure-html/bootstrap3-1.png" width="768" style="display: block; margin: auto;"></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Daniel Padfield, Hannah O'Sullivan.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
