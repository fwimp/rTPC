<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bootstrapping using rTPC • rTPC</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Bootstrapping using rTPC">
<meta property="og:description" content="rTPC">
<meta property="og:image" content="/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-74093873-3"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-74093873-3');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">rTPC</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/rTPC.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li class="divider">
    <li class="dropdown-header">Fitting a single curve</li>
    <li>
      <a href="../articles/fit_many_models.html">Fitting many models with rTPC</a>
    </li>
    <li>
      <a href="../articles/model_weighting.html">Model weighting with rTPC</a>
    </li>
    <li>
      <a href="../articles/model_averaging_selection.html">Model selection and model averaging with rTPC</a>
    </li>
    <li>
      <a href="../articles/bootstrapping_models.html">Bootstrapping using rTPC</a>
    </li>
    <li class="divider">
    <li class="dropdown-header">Fitting many curves</li>
    <li>
      <a href="../articles/fit_many_curves.html">Fitting many curves using rTPC</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/padpadpadpad/rTPC/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="bootstrapping_models_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Bootstrapping using rTPC</h1>
                        <h4 class="author">Daniel Padfield</h4>
            
            <h4 class="date">2020-07-20</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/padpadpadpad/rTPC/blob/master/vignettes/bootstrapping_models.Rmd"><code>vignettes/bootstrapping_models.Rmd</code></a></small>
      <div class="hidden name"><code>bootstrapping_models.Rmd</code></div>

    </div>

    
    
<div id="a-brief-example-of-how-model-weighting-can-be-used-to-help-account-for-measurement-uncertainty-when-fitting-models-to-tpcs-using-rtpc-nls-multstart-and-the-tidyverse-" class="section level4">
<h4 class="hasAnchor">
<a href="#a-brief-example-of-how-model-weighting-can-be-used-to-help-account-for-measurement-uncertainty-when-fitting-models-to-tpcs-using-rtpc-nls-multstart-and-the-tidyverse-" class="anchor"></a>A brief example of how model weighting can be used to help account for measurement uncertainty when fitting models to TPCs using rTPC, nls.multstart, and the tidyverse.</h4>
<hr>
</div>
<div id="things-to-consider" class="section level3">
<h3 class="hasAnchor">
<a href="#things-to-consider" class="anchor"></a>Things to consider</h3>
<ul>
<li><strong>This vignette is still a work in progress</strong></li>
<li>Significant differences between parameters can be evaluated by re-sampling the whole dataset with replacement</li>
<li>When there are fewer data points-per-curve, re-sampling the whole dataset with replacement may result in some re-sampled datasets not having any points beyond the optimum temperature</li>
<li>In these instances, creating new datasets from mean centre residuals of the original model fit can allow the confidence intervals of derived parameters to be estimated. However, these are likely to increase false positives if used for hypothesis testing.</li>
<li>Think carefully at about your level of replication.</li>
</ul>
<hr>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="co"># load packages</span>
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">rTPC</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">nls.multstart</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">broom</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">tidyverse</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">modelr</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">progress</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">patchwork</span>)

<span class="co"># edit nls_multstart to allow for a progress bar</span>
<span class="no">nls_multstart_progress</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">formula</span>, <span class="no">data</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sys.parent.html">parent.frame</a></span>(), <span class="no">iter</span>, <span class="no">start_lower</span>,
                                   <span class="no">start_upper</span>, <span class="no">supp_errors</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Y"</span>, <span class="st">"N"</span>), <span class="no">convergence_count</span> <span class="kw">=</span> <span class="fl">100</span>,
                                   <span class="no">control</span>, <span class="no">modelweights</span>, <span class="no">...</span>){
  <span class="kw">if</span>(!<span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span>(<span class="no">pb</span>)){
    <span class="no">pb</span>$<span class="fu">tick</span>()
  }
  <span class="fu"><a href="https://rdrr.io/pkg/nls.multstart/man/nls_multstart.html">nls_multstart</a></span>(<span class="kw">formula</span> <span class="kw">=</span> <span class="no">formula</span>, <span class="kw">data</span> <span class="kw">=</span> <span class="no">data</span>, <span class="kw">iter</span> <span class="kw">=</span> <span class="no">iter</span>, <span class="kw">start_lower</span> <span class="kw">=</span> <span class="no">start_lower</span>,
                <span class="kw">start_upper</span> <span class="kw">=</span> <span class="no">start_upper</span>, <span class="kw">supp_errors</span> <span class="kw">=</span> <span class="no">supp_errors</span>, <span class="kw">convergence_count</span> <span class="kw">=</span> <span class="no">convergence_count</span>,
                <span class="kw">control</span> <span class="kw">=</span> <span class="no">control</span>, <span class="kw">modelweights</span> <span class="kw">=</span> <span class="no">modelweights</span>, <span class="no">...</span>)
}</pre></body></html></div>
</div>
<div id="resampling-the-original-data-with-replacement" class="section level1">
<h1 class="hasAnchor">
<a href="#resampling-the-original-data-with-replacement" class="anchor"></a>Resampling the original data with replacement</h1>
<p>Bootstrapping involves simulating “new” datasets produced from the existing data by sampling with replacement. The same model is then fitted separately on each individual bootstrapped dataset. Doing this over and over allows us to visualise uncertainty of predictions and produce confidence intervals of estimated parameters.</p>
<p>First, we will demonstrate a situation when this approach works very well, using data from a recent paper by Padfield <em>et al.</em> (2020), that measures the thermal performance of the bacteria, <em>Pseudomonas fluorescens</em>, in the presence and absence of its phage, <span class="math inline">\(\phi 2\)</span>. In this study, each single growth rate estimate is a technical replicate, coming from an isogenic strain of bacteria either inoculated with, or without, the phage. As such, all the data points within each phage treatment can be used to estimate the same curve. This becomes obvious as there is no <code>rep</code> column as in the <code>chlorella_tpc</code> dataset, but we can visualise one of the curves (bacteria in the absence of phage), using <strong>ggplot2</strong>.</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="co"># load in data</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span>(<span class="st">"bacteria_tpc"</span>)

<span class="co"># keep just a single curve</span>
<span class="no">d</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">bacteria_tpc</span>, <span class="no">phage</span> <span class="kw">==</span> <span class="st">'nophage'</span>)

<span class="co"># show the data</span>
<span class="fu">ggplot</span>(<span class="no">d</span>, <span class="fu">aes</span>(<span class="no">temp</span>, <span class="no">rate</span>)) +
  <span class="fu">geom_point</span>(<span class="kw">size</span> <span class="kw">=</span> <span class="fl">2</span>, <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.5</span>) +
  <span class="fu">theme_bw</span>(<span class="kw">base_size</span> <span class="kw">=</span> <span class="fl">12</span>) +
  <span class="fu">labs</span>(<span class="kw">x</span> <span class="kw">=</span> <span class="st">'Temperature (ºC)'</span>,
       <span class="kw">y</span> <span class="kw">=</span> <span class="st">'Growth rate'</span>,
       <span class="kw">title</span> <span class="kw">=</span> <span class="st">'Growth rate across temperatures'</span>)</pre></body></html></div>
<p><img src="bootstrapping_models_files/figure-html/load_data-1.png" width="576" style="display: block; margin: auto;"></p>
<p>As in the study, we can fit the Sharpe-Schoolfield model to the data and plot the predictions using the approaches in <code>vignette(rTPC)</code> and <code>vignette(fit_many_models)</code>.</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="co"># fit Sharpe-Schoolfield model</span>
<span class="no">d_fit</span> <span class="kw">&lt;-</span> <span class="fu">nest</span>(<span class="no">d</span>, <span class="kw">data</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">temp</span>, <span class="no">rate</span>)) <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="kw">sharpeschoolhigh</span> <span class="kw">=</span> <span class="fu">map</span>(<span class="no">data</span>, ~<span class="fu"><a href="https://rdrr.io/pkg/nls.multstart/man/nls_multstart.html">nls_multstart</a></span>(<span class="no">rate</span>~<span class="fu"><a href="../reference/sharpeschoolhigh_1981.html">sharpeschoolhigh_1981</a></span>(<span class="kw">temp</span> <span class="kw">=</span> <span class="no">temp</span>, <span class="no">r_tref</span>,<span class="no">e</span>,<span class="no">eh</span>,<span class="no">th</span>, <span class="kw">tref</span> <span class="kw">=</span> <span class="fl">15</span>),
                        <span class="kw">data</span> <span class="kw">=</span> <span class="no">.x</span>,
                        <span class="kw">iter</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">3</span>,<span class="fl">3</span>,<span class="fl">3</span>,<span class="fl">3</span>),
                        <span class="kw">start_lower</span> <span class="kw">=</span> <span class="fu"><a href="../reference/get_start_vals.html">get_start_vals</a></span>(<span class="no">.x</span>$<span class="no">temp</span>, <span class="no">.x</span>$<span class="no">rate</span>, <span class="kw">model_name</span> <span class="kw">=</span> <span class="st">'sharpeschoolhigh_1981'</span>) - <span class="fl">10</span>,
                        <span class="kw">start_upper</span> <span class="kw">=</span> <span class="fu"><a href="../reference/get_start_vals.html">get_start_vals</a></span>(<span class="no">.x</span>$<span class="no">temp</span>, <span class="no">.x</span>$<span class="no">rate</span>, <span class="kw">model_name</span> <span class="kw">=</span> <span class="st">'sharpeschoolhigh_1981'</span>) + <span class="fl">10</span>,
                        <span class="kw">lower</span> <span class="kw">=</span> <span class="fu"><a href="../reference/get_lower_lims.html">get_lower_lims</a></span>(<span class="no">.x</span>$<span class="no">temp</span>, <span class="no">.x</span>$<span class="no">rate</span>, <span class="kw">model_name</span> <span class="kw">=</span> <span class="st">'sharpeschoolhigh_1981'</span>),
                        <span class="kw">upper</span> <span class="kw">=</span> <span class="fu"><a href="../reference/get_upper_lims.html">get_upper_lims</a></span>(<span class="no">.x</span>$<span class="no">temp</span>, <span class="no">.x</span>$<span class="no">rate</span>, <span class="kw">model_name</span> <span class="kw">=</span> <span class="st">'sharpeschoolhigh_1981'</span>),
                        <span class="kw">supp_errors</span> <span class="kw">=</span> <span class="st">'Y'</span>,
                        <span class="kw">convergence_count</span> <span class="kw">=</span> <span class="fl">FALSE</span>)),
         <span class="co"># create new temperature data</span>
         <span class="kw">new_data</span> <span class="kw">=</span> <span class="fu">map</span>(<span class="no">data</span>, ~<span class="fu">tibble</span>(<span class="kw">temp</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="no">.x</span>$<span class="no">temp</span>), <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="no">.x</span>$<span class="no">temp</span>), <span class="kw">length.out</span> <span class="kw">=</span> <span class="fl">100</span>))),
         <span class="co"># predict over that data,</span>
         <span class="kw">preds</span> <span class="kw">=</span>  <span class="fu">map2</span>(<span class="no">sharpeschoolhigh</span>, <span class="no">new_data</span>, ~<span class="fu"><a href="https://broom.tidymodels.org/reference/reexports.html">augment</a></span>(<span class="no">.x</span>, <span class="kw">newdata</span> <span class="kw">=</span> <span class="no">.y</span>)))

<span class="co"># unnest predictions</span>
<span class="no">d_preds</span> <span class="kw">&lt;-</span> <span class="fu">select</span>(<span class="no">d_fit</span>, <span class="no">preds</span>) <span class="kw">%&gt;%</span>
  <span class="fu">unnest</span>(<span class="no">preds</span>)

<span class="co"># plot data and predictions</span>
<span class="fu">ggplot</span>() +
  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="no">temp</span>, <span class="no">.fitted</span>), <span class="no">d_preds</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="st">'blue'</span>) +
  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="no">temp</span>, <span class="no">rate</span>), <span class="no">d</span>, <span class="kw">size</span> <span class="kw">=</span> <span class="fl">2</span>, <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.5</span>) +
  <span class="fu">theme_bw</span>(<span class="kw">base_size</span> <span class="kw">=</span> <span class="fl">12</span>) +
  <span class="fu">labs</span>(<span class="kw">x</span> <span class="kw">=</span> <span class="st">'Temperature (ºC)'</span>,
       <span class="kw">y</span> <span class="kw">=</span> <span class="st">'Growth rate'</span>,
       <span class="kw">title</span> <span class="kw">=</span> <span class="st">'Growth rate across temperatures'</span>)</pre></body></html></div>
<p><img src="bootstrapping_models_files/figure-html/fit_and_plot-1.png" width="576" style="display: block; margin: auto;"> Here we have the best fit to the data. If we want confidence bands around this prediction, we can get those by resampling the data a number of times. To illustrate this approach, I will create 250 bootstraps of the data and fit separate models to each using the <strong>modelr</strong> package. We will create a progress bar as used in <code>vignette(fit_many_curves)</code> to track the progress of the fit.</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="co"># number of boots</span>
<span class="no">n_boots</span> <span class="kw">&lt;-</span> <span class="fl">250</span>

<span class="co"># create new datasets and prepare them for fitting</span>
<span class="no">d_boots</span> <span class="kw">&lt;-</span> <span class="fu">group_by</span>(<span class="no">d</span>, <span class="no">phage</span>) <span class="kw">%&gt;%</span>
  <span class="fu">do</span>(<span class="kw pkg">modelr</span><span class="kw ns">::</span><span class="fu"><a href="https://modelr.tidyverse.org/reference/bootstrap.html">bootstrap</a></span>(<span class="no">.</span>, <span class="kw">n</span> <span class="kw">=</span> <span class="no">n_boots</span>, <span class="kw">id</span> <span class="kw">=</span> <span class="st">'boot_num'</span>)) <span class="kw">%&gt;%</span>
  <span class="fu">ungroup</span>() <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="kw">strap</span> <span class="kw">=</span> <span class="fu">map</span>(<span class="no">strap</span>, <span class="no">data.frame</span>))

<span class="co"># start progress bar and estimate time it will take</span>
<span class="no">number_of_models</span> <span class="kw">&lt;-</span> <span class="fl">1</span>

<span class="co"># setup progress bar</span>
<span class="no">pb</span> <span class="kw">&lt;-</span> <span class="kw pkg">progress</span><span class="kw ns">::</span><span class="no"><a href="https://rdrr.io/pkg/progress/man/progress_bar.html">progress_bar</a></span>$<span class="fu">new</span>(<span class="kw">total</span> <span class="kw">=</span> <span class="no">n_boots</span>*<span class="no">number_of_models</span>,
                                 <span class="kw">clear</span> <span class="kw">=</span> <span class="fl">FALSE</span>,
                                 <span class="kw">format</span> <span class="kw">=</span><span class="st">"[:bar] :percent :elapsedfull"</span>)


<span class="co"># fit each model</span>
<span class="no">d_boots</span> <span class="kw">&lt;-</span> <span class="fu">mutate</span>(<span class="no">d_boots</span>, <span class="kw">refit</span> <span class="kw">=</span> <span class="fu">map</span>(<span class="no">strap</span>, ~ <span class="fu">nls_multstart_progress</span>(<span class="no">rate</span>~<span class="fu"><a href="../reference/sharpeschoolhigh_1981.html">sharpeschoolhigh_1981</a></span>(<span class="kw">temp</span> <span class="kw">=</span> <span class="no">temp</span>, <span class="no">r_tref</span>,<span class="no">e</span>,<span class="no">eh</span>,<span class="no">th</span>, <span class="kw">tref</span> <span class="kw">=</span> <span class="fl">15</span>),
                        <span class="kw">data</span> <span class="kw">=</span> <span class="no">.x</span>,
                        <span class="kw">iter</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">3</span>,<span class="fl">3</span>,<span class="fl">3</span>,<span class="fl">3</span>),
                        <span class="kw">start_lower</span> <span class="kw">=</span> <span class="fu"><a href="../reference/get_start_vals.html">get_start_vals</a></span>(<span class="no">.x</span>$<span class="no">temp</span>, <span class="no">.x</span>$<span class="no">rate</span>, <span class="kw">model_name</span> <span class="kw">=</span> <span class="st">'sharpeschoolhigh_1981'</span>) - <span class="fl">10</span>,
                        <span class="kw">start_upper</span> <span class="kw">=</span> <span class="fu"><a href="../reference/get_start_vals.html">get_start_vals</a></span>(<span class="no">.x</span>$<span class="no">temp</span>, <span class="no">.x</span>$<span class="no">rate</span>, <span class="kw">model_name</span> <span class="kw">=</span> <span class="st">'sharpeschoolhigh_1981'</span>) + <span class="fl">10</span>,
                        <span class="kw">lower</span> <span class="kw">=</span> <span class="fu"><a href="../reference/get_lower_lims.html">get_lower_lims</a></span>(<span class="no">.x</span>$<span class="no">temp</span>, <span class="no">.x</span>$<span class="no">rate</span>, <span class="kw">model_name</span> <span class="kw">=</span> <span class="st">'sharpeschoolhigh_1981'</span>),
                        <span class="kw">upper</span> <span class="kw">=</span> <span class="fu"><a href="../reference/get_upper_lims.html">get_upper_lims</a></span>(<span class="no">.x</span>$<span class="no">temp</span>, <span class="no">.x</span>$<span class="no">rate</span>, <span class="kw">model_name</span> <span class="kw">=</span> <span class="st">'sharpeschoolhigh_1981'</span>),
                        <span class="kw">supp_errors</span> <span class="kw">=</span> <span class="st">'Y'</span>,
                        <span class="kw">convergence_count</span> <span class="kw">=</span> <span class="fl">FALSE</span>)),
                  <span class="co"># create new temperature data</span>
                  <span class="kw">new_data</span> <span class="kw">=</span> <span class="fu">map</span>(<span class="no">strap</span>, ~<span class="fu">tibble</span>(<span class="kw">temp</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="no">.x</span>$<span class="no">temp</span>), <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="no">.x</span>$<span class="no">temp</span>), <span class="kw">by</span> <span class="kw">=</span> <span class="fl">0.1</span>))),
                  <span class="co"># predict over that data</span>
                  <span class="kw">preds</span> <span class="kw">=</span>  <span class="fu">map2</span>(<span class="no">refit</span>, <span class="no">new_data</span>, ~<span class="fu"><a href="https://broom.tidymodels.org/reference/reexports.html">augment</a></span>(<span class="no">.x</span>, <span class="kw">newdata</span> <span class="kw">=</span> <span class="no">.y</span>)))</pre></body></html></div>
<pre><code>[=========================================================] 100% 00:02:04</code></pre>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="fu">glimpse</span>(<span class="no">d_boots</span>)
<span class="co">#&gt; Rows: 250</span>
<span class="co">#&gt; Columns: 6</span>
<span class="co">#&gt; $ phage    &lt;chr&gt; "nophage", "nophage", "nophage", "nophage", "nophage", "noph…</span>
<span class="co">#&gt; $ strap    &lt;list&gt; [&lt;data.frame[47 x 3]&gt;, &lt;data.frame[47 x 3]&gt;, &lt;data.frame[47…</span>
<span class="co">#&gt; $ boot_num &lt;chr&gt; "001", "002", "003", "004", "005", "006", "007", "008", "009…</span>
<span class="co">#&gt; $ refit    &lt;list&gt; [&lt;function () , resid, function () , rhs, function () , for…</span>
<span class="co">#&gt; $ new_data &lt;list&gt; [&lt;tbl_df[221 x 1]&gt;, &lt;tbl_df[221 x 1]&gt;, &lt;tbl_df[221 x 1]&gt;, &lt;…</span>
<span class="co">#&gt; $ preds    &lt;list&gt; [&lt;tbl_df[221 x 2]&gt;, &lt;tbl_df[221 x 2]&gt;, &lt;tbl_df[221 x 2]&gt;, &lt;…</span></pre></body></html></div>
<p>Each bootstrapped model is stored in <code>refit</code>, with the predictions stored in <code>preds</code>. We can easily create confidence intervals around the original fitted predictions and overlay them onto our first plot. We can also just show some of the bootstrapped predictions alongside those of the original model.</p>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="co"># calculate bootstrapped confidence intervals</span>
<span class="no">d_conf</span> <span class="kw">&lt;-</span> <span class="fu">select</span>(<span class="no">d_boots</span>, <span class="no">preds</span>) <span class="kw">%&gt;%</span>
  <span class="fu">unnest</span>(<span class="no">preds</span>) <span class="kw">%&gt;%</span>
  <span class="fu">group_by</span>(<span class="no">temp</span>) <span class="kw">%&gt;%</span>
  <span class="fu">summarise</span>(<span class="kw">conf_lower</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span>(<span class="no">.fitted</span>, <span class="fl">0.025</span>),
         <span class="kw">conf_upper</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span>(<span class="no">.fitted</span>, <span class="fl">0.975</span>)) <span class="kw">%&gt;%</span>
  <span class="fu">ungroup</span>()
<span class="co">#&gt; `summarise()` ungrouping output (override with `.groups` argument)</span>

<span class="co"># unnest all predictions</span>
<span class="no">d_boot_preds</span> <span class="kw">&lt;-</span> <span class="fu">select</span>(<span class="no">d_boots</span>, <span class="no">boot_num</span>, <span class="no">preds</span>) <span class="kw">%&gt;%</span>
  <span class="fu">unnest</span>(<span class="no">preds</span>)

<span class="co"># plot bootstrapped CIs</span>
<span class="no">p1</span> <span class="kw">&lt;-</span> <span class="fu">ggplot</span>() +
  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="no">temp</span>, <span class="no">.fitted</span>), <span class="no">d_preds</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="st">'blue'</span>) +
  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="no">temp</span>, <span class="kw">ymin</span> <span class="kw">=</span> <span class="no">conf_lower</span>, <span class="kw">ymax</span> <span class="kw">=</span> <span class="no">conf_upper</span>), <span class="no">d_conf</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="st">'blue'</span>, <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.3</span>) +
  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="no">temp</span>, <span class="no">rate</span>), <span class="no">d</span>, <span class="kw">size</span> <span class="kw">=</span> <span class="fl">2</span>, <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.5</span>) +
  <span class="fu">theme_bw</span>(<span class="kw">base_size</span> <span class="kw">=</span> <span class="fl">12</span>) +
  <span class="fu">labs</span>(<span class="kw">x</span> <span class="kw">=</span> <span class="st">'Temperature (ºC)'</span>,
       <span class="kw">y</span> <span class="kw">=</span> <span class="st">'Growth rate'</span>,
       <span class="kw">title</span> <span class="kw">=</span> <span class="st">'Growth rate across temperatures'</span>)

<span class="co"># plot bootstrapped predictions</span>
<span class="no">p2</span> <span class="kw">&lt;-</span> <span class="fu">ggplot</span>() +
  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="no">temp</span>, <span class="no">.fitted</span>), <span class="no">d_preds</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="st">'blue'</span>) +
  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="no">temp</span>, <span class="no">.fitted</span>, <span class="kw">group</span> <span class="kw">=</span> <span class="no">boot_num</span>), <span class="no">d_boot_preds</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="st">'blue'</span>, <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.03</span>) +
  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="no">temp</span>, <span class="no">rate</span>), <span class="no">d</span>, <span class="kw">size</span> <span class="kw">=</span> <span class="fl">2</span>, <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.5</span>) +
  <span class="fu">theme_bw</span>(<span class="kw">base_size</span> <span class="kw">=</span> <span class="fl">12</span>) +
  <span class="fu">labs</span>(<span class="kw">x</span> <span class="kw">=</span> <span class="st">'Temperature (ºC)'</span>,
       <span class="kw">y</span> <span class="kw">=</span> <span class="st">'Growth rate'</span>,
       <span class="kw">title</span> <span class="kw">=</span> <span class="st">'Growth rate across temperatures'</span>)

<span class="no">p1</span> + <span class="no">p2</span></pre></body></html></div>
<p><img src="bootstrapping_models_files/figure-html/plot_boots-1.png" width="768" style="display: block; margin: auto;"></p>
<p>This method becomes more problematic when there is a small sample size. It is common for thermal performance curves to only have a single measurement at each temperature. This means that lots of the bootstrapped models will not have any points from that temperature. This can be seen by bootstrapping-with-replacement a curve from the <code>chlorella_tpc</code> dataset used throughout these vignettes.</p>
<div class="sourceCode" id="cb8"><html><body><pre class="r"><span class="co"># load in chlorella data</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span>(<span class="st">'chlorella_tpc'</span>)
<span class="no">d2</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">chlorella_tpc</span>, <span class="no">curve_id</span> <span class="kw">==</span> <span class="fl">1</span>)

<span class="co"># number of boots</span>
<span class="no">n_boots</span> <span class="kw">&lt;-</span> <span class="fl">250</span>

<span class="co"># create new datasets and prepare them for fitting</span>
<span class="no">d_boots</span> <span class="kw">&lt;-</span> <span class="fu">group_by</span>(<span class="no">d2</span>, <span class="no">curve_id</span>) <span class="kw">%&gt;%</span>
  <span class="fu">do</span>(<span class="kw pkg">modelr</span><span class="kw ns">::</span><span class="fu"><a href="https://modelr.tidyverse.org/reference/bootstrap.html">bootstrap</a></span>(<span class="no">.</span>, <span class="kw">n</span> <span class="kw">=</span> <span class="no">n_boots</span>, <span class="kw">id</span> <span class="kw">=</span> <span class="st">'boot_num'</span>)) <span class="kw">%&gt;%</span>
  <span class="fu">ungroup</span>() <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="kw">strap</span> <span class="kw">=</span> <span class="fu">map</span>(<span class="no">strap</span>, <span class="no">data.frame</span>))

<span class="co"># plot ten of these alongside the actual data</span>
<span class="no">d_boots_plot</span> <span class="kw">&lt;-</span> <span class="fu">select</span>(<span class="no">d_boots</span>, -<span class="no">curve_id</span>) <span class="kw">%&gt;%</span>
  <span class="fu">unnest</span>(<span class="no">strap</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">boot_num</span>) <span class="kw">&lt;</span> <span class="fl">8</span>) <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="no">.</span>, <span class="kw">boot_num</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">'bootstrap'</span>, <span class="no">boot_num</span>, <span class="kw">sep</span> <span class="kw">=</span> <span class="st">' '</span>)) <span class="kw">%&gt;%</span>
  <span class="fu">bind_rows</span>(<span class="no">.</span>, <span class="fu">mutate</span>(<span class="no">d2</span>, <span class="kw">boot_num</span> <span class="kw">=</span> <span class="st">'actual_data'</span>))

<span class="co"># plot</span>
<span class="fu">ggplot</span>(<span class="no">d_boots_plot</span>, <span class="fu">aes</span>(<span class="no">temp</span>, <span class="no">rate</span>)) +
  <span class="fu">geom_point</span>(<span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.5</span>) +
  <span class="fu">facet_wrap</span>(~<span class="no">boot_num</span>) +
  <span class="fu">theme_bw</span>() +
  <span class="fu">theme</span>(<span class="kw">strip.background</span> <span class="kw">=</span> <span class="fu">element_blank</span>(),
        <span class="kw">strip.text</span> <span class="kw">=</span> <span class="fu">element_text</span>(<span class="kw">hjust</span> <span class="kw">=</span> <span class="fl">0</span>))</pre></body></html></div>
<p><img src="bootstrapping_models_files/figure-html/bootstrap_models2_plot-1.png" width="768" style="display: block; margin: auto;"></p>
<p>By plotting some of the bootstrapped datasets, we can see which points of the original data were resampled (darker points). There are many different curves that can come from these resampled curves. This is likely to be a bigger problem when there is only one point beyond the optimum of the curve. We can see how much of a problem this is when we model the raw data and the bootstrapped data as before.</p>
<p>As before, the model predictions of each bootstrap are taken only from the range of temperatures of that bootstrapped dataset, not the range of values of the raw dataset.</p>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="co"># fit Sharpe-Schoolfield model to raw data</span>
<span class="no">d_fit</span> <span class="kw">&lt;-</span> <span class="fu">nest</span>(<span class="no">d2</span>, <span class="kw">data</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">temp</span>, <span class="no">rate</span>)) <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="kw">sharpeschoolhigh</span> <span class="kw">=</span> <span class="fu">map</span>(<span class="no">data</span>, ~<span class="fu"><a href="https://rdrr.io/pkg/nls.multstart/man/nls_multstart.html">nls_multstart</a></span>(<span class="no">rate</span>~<span class="fu"><a href="../reference/sharpeschoolhigh_1981.html">sharpeschoolhigh_1981</a></span>(<span class="kw">temp</span> <span class="kw">=</span> <span class="no">temp</span>, <span class="no">r_tref</span>,<span class="no">e</span>,<span class="no">eh</span>,<span class="no">th</span>, <span class="kw">tref</span> <span class="kw">=</span> <span class="fl">15</span>),
                        <span class="kw">data</span> <span class="kw">=</span> <span class="no">.x</span>,
                        <span class="kw">iter</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">3</span>,<span class="fl">3</span>,<span class="fl">3</span>,<span class="fl">3</span>),
                        <span class="kw">start_lower</span> <span class="kw">=</span> <span class="fu"><a href="../reference/get_start_vals.html">get_start_vals</a></span>(<span class="no">.x</span>$<span class="no">temp</span>, <span class="no">.x</span>$<span class="no">rate</span>, <span class="kw">model_name</span> <span class="kw">=</span> <span class="st">'sharpeschoolhigh_1981'</span>) - <span class="fl">10</span>,
                        <span class="kw">start_upper</span> <span class="kw">=</span> <span class="fu"><a href="../reference/get_start_vals.html">get_start_vals</a></span>(<span class="no">.x</span>$<span class="no">temp</span>, <span class="no">.x</span>$<span class="no">rate</span>, <span class="kw">model_name</span> <span class="kw">=</span> <span class="st">'sharpeschoolhigh_1981'</span>) + <span class="fl">10</span>,
                        <span class="kw">lower</span> <span class="kw">=</span> <span class="fu"><a href="../reference/get_lower_lims.html">get_lower_lims</a></span>(<span class="no">.x</span>$<span class="no">temp</span>, <span class="no">.x</span>$<span class="no">rate</span>, <span class="kw">model_name</span> <span class="kw">=</span> <span class="st">'sharpeschoolhigh_1981'</span>),
                        <span class="kw">upper</span> <span class="kw">=</span> <span class="fu"><a href="../reference/get_upper_lims.html">get_upper_lims</a></span>(<span class="no">.x</span>$<span class="no">temp</span>, <span class="no">.x</span>$<span class="no">rate</span>, <span class="kw">model_name</span> <span class="kw">=</span> <span class="st">'sharpeschoolhigh_1981'</span>),
                        <span class="kw">supp_errors</span> <span class="kw">=</span> <span class="st">'Y'</span>,
                        <span class="kw">convergence_count</span> <span class="kw">=</span> <span class="fl">FALSE</span>)),
         <span class="co"># create new temperature data</span>
         <span class="kw">new_data</span> <span class="kw">=</span> <span class="fu">map</span>(<span class="no">data</span>, ~<span class="fu">tibble</span>(<span class="kw">temp</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="no">.x</span>$<span class="no">temp</span>), <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="no">.x</span>$<span class="no">temp</span>), <span class="kw">length.out</span> <span class="kw">=</span> <span class="fl">100</span>))),
         <span class="co"># predict over that data,</span>
         <span class="kw">preds</span> <span class="kw">=</span>  <span class="fu">map2</span>(<span class="no">sharpeschoolhigh</span>, <span class="no">new_data</span>, ~<span class="fu"><a href="https://broom.tidymodels.org/reference/reexports.html">augment</a></span>(<span class="no">.x</span>, <span class="kw">newdata</span> <span class="kw">=</span> <span class="no">.y</span>)))

<span class="co"># start progress bar and estimate time it will take</span>
<span class="no">number_of_models</span> <span class="kw">&lt;-</span> <span class="fl">1</span>

<span class="co"># setup progress bar</span>
<span class="no">pb</span> <span class="kw">&lt;-</span> <span class="kw pkg">progress</span><span class="kw ns">::</span><span class="no"><a href="https://rdrr.io/pkg/progress/man/progress_bar.html">progress_bar</a></span>$<span class="fu">new</span>(<span class="kw">total</span> <span class="kw">=</span> <span class="no">n_boots</span>*<span class="no">number_of_models</span>,
                                 <span class="kw">clear</span> <span class="kw">=</span> <span class="fl">FALSE</span>,
                                 <span class="kw">format</span> <span class="kw">=</span><span class="st">"[:bar] :percent :elapsedfull"</span>)

<span class="no">nls_multstart_safe</span> <span class="kw">&lt;-</span> <span class="fu">possibly</span>(<span class="no">nls_multstart_progress</span>, <span class="kw">otherwise</span> <span class="kw">=</span> <span class="fl">NA</span>, <span class="kw">quiet</span> <span class="kw">=</span> <span class="fl">TRUE</span>)

<span class="co"># fit each model</span>
<span class="no">d_boots</span> <span class="kw">&lt;-</span> <span class="fu">mutate</span>(<span class="no">d_boots</span>, <span class="kw">refit</span> <span class="kw">=</span> <span class="fu">map</span>(<span class="no">strap</span>, ~ <span class="fu">nls_multstart_safe</span>(<span class="no">rate</span>~<span class="fu"><a href="../reference/sharpeschoolhigh_1981.html">sharpeschoolhigh_1981</a></span>(<span class="kw">temp</span> <span class="kw">=</span> <span class="no">temp</span>, <span class="no">r_tref</span>,<span class="no">e</span>,<span class="no">eh</span>,<span class="no">th</span>, <span class="kw">tref</span> <span class="kw">=</span> <span class="fl">15</span>),
                        <span class="kw">data</span> <span class="kw">=</span> <span class="no">.x</span>,
                        <span class="kw">iter</span> <span class="kw">=</span> <span class="fl">200</span>,
                        <span class="kw">start_lower</span> <span class="kw">=</span> <span class="fu"><a href="../reference/get_start_vals.html">get_start_vals</a></span>(<span class="no">.x</span>$<span class="no">temp</span>, <span class="no">.x</span>$<span class="no">rate</span>, <span class="kw">model_name</span> <span class="kw">=</span> <span class="st">'sharpeschoolhigh_1981'</span>) - <span class="fl">10</span>,
                        <span class="kw">start_upper</span> <span class="kw">=</span> <span class="fu"><a href="../reference/get_start_vals.html">get_start_vals</a></span>(<span class="no">.x</span>$<span class="no">temp</span>, <span class="no">.x</span>$<span class="no">rate</span>, <span class="kw">model_name</span> <span class="kw">=</span> <span class="st">'sharpeschoolhigh_1981'</span>) + <span class="fl">10</span>,
                        <span class="kw">lower</span> <span class="kw">=</span> <span class="fu"><a href="../reference/get_lower_lims.html">get_lower_lims</a></span>(<span class="no">.x</span>$<span class="no">temp</span>, <span class="no">.x</span>$<span class="no">rate</span>, <span class="kw">model_name</span> <span class="kw">=</span> <span class="st">'sharpeschoolhigh_1981'</span>),
                        <span class="kw">upper</span> <span class="kw">=</span> <span class="fu"><a href="../reference/get_upper_lims.html">get_upper_lims</a></span>(<span class="no">.x</span>$<span class="no">temp</span>, <span class="no">.x</span>$<span class="no">rate</span>, <span class="kw">model_name</span> <span class="kw">=</span> <span class="st">'sharpeschoolhigh_1981'</span>),
                        <span class="kw">supp_errors</span> <span class="kw">=</span> <span class="st">'Y'</span>,
                        <span class="kw">convergence_count</span> <span class="kw">=</span> <span class="fl">FALSE</span>)))
<span class="co">#&gt; Warning in runif(iter, .x, .y): NAs produced</span>

<span class="co">#&gt; Warning in runif(iter, .x, .y): NAs produced</span>

<span class="co">#&gt; Warning in runif(iter, .x, .y): NAs produced</span>

<span class="co">#&gt; Warning in runif(iter, .x, .y): NAs produced</span>

<span class="co">#&gt; Warning in runif(iter, .x, .y): NAs produced</span>

<span class="co">#&gt; Warning in runif(iter, .x, .y): NAs produced</span>

<span class="co">#&gt; Warning in runif(iter, .x, .y): NAs produced</span>

<span class="co">#&gt; Warning in runif(iter, .x, .y): NAs produced</span>

<span class="co">#&gt; Warning in runif(iter, .x, .y): NAs produced</span>

<span class="co">#&gt; Warning in runif(iter, .x, .y): NAs produced</span>

<span class="co">#&gt; Warning in runif(iter, .x, .y): NAs produced</span>

<span class="co">#&gt; Warning in runif(iter, .x, .y): NAs produced</span>

<span class="co">#&gt; Warning in runif(iter, .x, .y): NAs produced</span>

<span class="co"># remove fits that are NA</span>
<span class="no">d_boots</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">d_boots</span>, !<span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="no">refit</span>))
<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">d_boots</span>)
<span class="co">#&gt; [1] 237</span>

<span class="co"># create new temperature data</span>
<span class="no">d_boots</span> <span class="kw">&lt;-</span> <span class="fu">mutate</span>(<span class="no">d_boots</span>, <span class="kw">new_data</span> <span class="kw">=</span> <span class="fu">map</span>(<span class="no">strap</span>, ~<span class="fu">tibble</span>(<span class="kw">temp</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="no">.x</span>$<span class="no">temp</span>), <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="no">.x</span>$<span class="no">temp</span>), <span class="kw">by</span> <span class="kw">=</span> <span class="fl">0.1</span>))),
                  <span class="co"># predict over that data</span>
                  <span class="kw">preds</span> <span class="kw">=</span>  <span class="fu">map2</span>(<span class="no">refit</span>, <span class="no">new_data</span>, ~<span class="fu"><a href="https://broom.tidymodels.org/reference/reexports.html">augment</a></span>(<span class="no">.x</span>, <span class="kw">newdata</span> <span class="kw">=</span> <span class="no">.y</span>)))

<span class="co"># calculate bootstrapped confidence intervals</span>
<span class="no">d_conf</span> <span class="kw">&lt;-</span> <span class="fu">select</span>(<span class="no">d_boots</span>, <span class="no">preds</span>) <span class="kw">%&gt;%</span>
  <span class="fu">unnest</span>(<span class="no">preds</span>) <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="kw">temp</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="no">temp</span>, <span class="fl">1</span>)) <span class="kw">%&gt;%</span>
  <span class="fu">group_by</span>(<span class="no">temp</span>) <span class="kw">%&gt;%</span>
  <span class="fu">summarise</span>(<span class="kw">conf_lower</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span>(<span class="no">.fitted</span>, <span class="fl">0.025</span>),
         <span class="kw">conf_upper</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span>(<span class="no">.fitted</span>, <span class="fl">0.975</span>)) <span class="kw">%&gt;%</span>
  <span class="fu">ungroup</span>()
<span class="co">#&gt; `summarise()` ungrouping output (override with `.groups` argument)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">d_conf</span>)
<span class="co">#&gt; # A tibble: 6 x 3</span>
<span class="co">#&gt;    temp conf_lower conf_upper</span>
<span class="co">#&gt;   &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;</span>
<span class="co">#&gt; 1  16        0.114      0.331</span>
<span class="co">#&gt; 2  16.1      0.116      0.333</span>
<span class="co">#&gt; 3  16.2      0.118      0.335</span>
<span class="co">#&gt; 4  16.3      0.121      0.338</span>
<span class="co">#&gt; 5  16.4      0.123      0.340</span>
<span class="co">#&gt; 6  16.5      0.125      0.343</span>

<span class="co"># unnest all predictions</span>
<span class="no">d_boot_preds</span> <span class="kw">&lt;-</span> <span class="fu">select</span>(<span class="no">d_boots</span>, <span class="no">boot_num</span>, <span class="no">preds</span>) <span class="kw">%&gt;%</span>
  <span class="fu">unnest</span>(<span class="no">preds</span>)

<span class="co"># unnest predictions</span>
<span class="no">d_preds</span> <span class="kw">&lt;-</span> <span class="fu">select</span>(<span class="no">d_fit</span>, <span class="no">preds</span>) <span class="kw">%&gt;%</span>
  <span class="fu">unnest</span>(<span class="no">preds</span>)

<span class="co"># plot bootstrapped CIs</span>
<span class="no">p1</span> <span class="kw">&lt;-</span> <span class="fu">ggplot</span>() +
  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="no">temp</span>, <span class="no">.fitted</span>), <span class="no">d_preds</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="st">'blue'</span>) +
  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="no">temp</span>, <span class="kw">ymin</span> <span class="kw">=</span> <span class="no">conf_lower</span>, <span class="kw">ymax</span> <span class="kw">=</span> <span class="no">conf_upper</span>), <span class="no">d_conf</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="st">'blue'</span>, <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.3</span>) +
  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="no">temp</span>, <span class="no">rate</span>), <span class="no">d2</span>, <span class="kw">size</span> <span class="kw">=</span> <span class="fl">2</span>, <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.5</span>) +
  <span class="fu">theme_bw</span>(<span class="kw">base_size</span> <span class="kw">=</span> <span class="fl">12</span>) +
  <span class="fu">labs</span>(<span class="kw">x</span> <span class="kw">=</span> <span class="st">'Temperature (ºC)'</span>,
       <span class="kw">y</span> <span class="kw">=</span> <span class="st">'Growth rate'</span>,
       <span class="kw">title</span> <span class="kw">=</span> <span class="st">'Growth rate across temperatures'</span>)

<span class="co"># plot bootstrapped predictions</span>
<span class="no">p2</span> <span class="kw">&lt;-</span> <span class="fu">ggplot</span>() +
  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="no">temp</span>, <span class="no">.fitted</span>), <span class="no">d_preds</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="st">'blue'</span>) +
  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="no">temp</span>, <span class="no">.fitted</span>, <span class="kw">group</span> <span class="kw">=</span> <span class="no">boot_num</span>), <span class="no">d_boot_preds</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="st">'blue'</span>, <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.03</span>) +
  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="no">temp</span>, <span class="no">rate</span>), <span class="no">d2</span>, <span class="kw">size</span> <span class="kw">=</span> <span class="fl">2</span>, <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.3</span>) +
  <span class="fu">theme_bw</span>(<span class="kw">base_size</span> <span class="kw">=</span> <span class="fl">12</span>) +
  <span class="fu">labs</span>(<span class="kw">x</span> <span class="kw">=</span> <span class="st">'Temperature (ºC)'</span>,
       <span class="kw">y</span> <span class="kw">=</span> <span class="st">'Growth rate'</span>,
       <span class="kw">title</span> <span class="kw">=</span> <span class="st">'Growth rate across temperatures'</span>)

<span class="no">p1</span> + <span class="no">p2</span></pre></body></html></div>
<p><img src="bootstrapping_models_files/figure-html/bootstrap_models2-1.png" width="768" style="display: block; margin: auto;"></p>
<p>As can be seen, bootstrapping-with-replacement with only a single point at each temperature can lead to a large variety of fits. In the second panel, we can see the variety of the curve fits, clustering around 4 possible paths for the decrease in rate beyond the optimum temperature. This makes the uncertainty around these predictions, and the derived estimate <span class="math inline">\(E_h\)</span> highly uncertain using this method of bootstrapping.</p>
</div>
<div id="resampling-residuals" class="section level1">
<h1 class="hasAnchor">
<a href="#resampling-residuals" class="anchor"></a>Resampling residuals</h1>
<p>Re-sampling the data with replacement is the most common way of thinking about bootstrapping. However, bootstrapping ordinary least squares regression models is often done using bootstrapping residuals.</p>
<hr>
<p>NB The Padfield _et al.__ analysis actually uses a Bayesian approach to fit thermal performance curves, quantify uncertainty, and estimate derived parameters. This approach is powerful and flexible, and becoming easier to use with the incredible development of the R package <a href="https://github.com/paul-buerkner/brms"><strong>brms</strong></a>. Examples of using <strong>brms</strong> to model thermal performance curves can be found on the <a href="https://github.com/padpadpadpad/Padfield_2019_ISME_bact_phage_temperature">GitHub repository</a> of the paper</p>
<hr>
<div id="references" class="section level4">
<h4 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h4>
<ul>
<li><a href="https://statweb.stanford.edu/~owen/courses/305a/FoxOnBootingRegInR.pdf" class="uri">https://statweb.stanford.edu/~owen/courses/305a/FoxOnBootingRegInR.pdf</a></li>
<li><a href="http://wangyuchen.github.io/rnote/chap4-1.html#leverage-values" class="uri">http://wangyuchen.github.io/rnote/chap4-1.html#leverage-values</a></li>
<li><a href="https://stats.stackexchange.com/questions/29990/identifying-outliers-for-non-linear-regression" class="uri">https://stats.stackexchange.com/questions/29990/identifying-outliers-for-non-linear-regression</a></li>
<li><a href="https://www.stat.cmu.edu/~cshalizi/402/lectures/08-bootstrap/lecture-08.pdf" class="uri">https://www.stat.cmu.edu/~cshalizi/402/lectures/08-bootstrap/lecture-08.pdf</a></li>
<li><a href="https://people.math.umass.edu/~johnpb/s697m/boot.pdf" class="uri">https://people.math.umass.edu/~johnpb/s697m/boot.pdf</a></li>
</ul>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Daniel Padfield, Hannah O'Sullivan.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
