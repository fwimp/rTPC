<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bootstrapping using rTPC • rTPC</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Bootstrapping using rTPC">
<meta property="og:description" content="rTPC">
<meta property="og:image" content="/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-74093873-3"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-74093873-3');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">rTPC</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/rTPC.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li class="divider">
    <li class="dropdown-header">Fitting a single curve</li>
    <li>
      <a href="../articles/fit_many_models.html">Fitting many models with rTPC</a>
    </li>
    <li>
      <a href="../articles/model_weighting.html">Model weighting with rTPC</a>
    </li>
    <li>
      <a href="../articles/model_averaging_selection.html">Model selection and model averaging with rTPC</a>
    </li>
    <li>
      <a href="../articles/bootstrapping_models.html">Bootstrapping using rTPC</a>
    </li>
    <li>
      <a href="../articles/weighted_bootstrapping.html">Bootstrapping with weights using rTPC</a>
    </li>
    <li class="divider">
    <li class="dropdown-header">Fitting many curves</li>
    <li>
      <a href="../articles/fit_many_curves.html">Fitting many curves using rTPC</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/padpadpadpad/rTPC/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="bootstrapping_models_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Bootstrapping using rTPC</h1>
                        <h4 class="author">Daniel Padfield</h4>
            
            <h4 class="date">2020-09-03</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/padpadpadpad/rTPC/blob/master/vignettes/bootstrapping_models.Rmd"><code>vignettes/bootstrapping_models.Rmd</code></a></small>
      <div class="hidden name"><code>bootstrapping_models.Rmd</code></div>

    </div>

    
    
<div id="a-brief-example-of-how-bootstrapping-can-help-visualise-and-estimate-model-uncertainty-when-fitting-models-to-tpcs-using-rtpc-nls-multstart-car-and-the-tidyverse-" class="section level4">
<h4 class="hasAnchor">
<a href="#a-brief-example-of-how-bootstrapping-can-help-visualise-and-estimate-model-uncertainty-when-fitting-models-to-tpcs-using-rtpc-nls-multstart-car-and-the-tidyverse-" class="anchor"></a>A brief example of how bootstrapping can help visualise and estimate model uncertainty when fitting models to TPCs using rTPC, nls.multstart, car and the tidyverse.</h4>
<hr>
</div>
<div id="things-to-consider" class="section level2">
<h2 class="hasAnchor">
<a href="#things-to-consider" class="anchor"></a>Things to consider</h2>
<ul>
<li>Confidence intervals of model predictions can be produced for non-linear least squares regression models using bootstrapping.</li>
<li>Bootstrapping can also allow differences between explicitly modelled and calculated parameters to be evaluated.</li>
<li>Case resampling involves resampling the actual data with replacement and then refitting the model to the new, simulated datasets.</li>
<li>When there are fewer data points-per-curve, re-sampling the whole dataset with replacement may result in some re-sampled datasets not having any points beyond the optimum temperature.</li>
<li>In these instances, residual sampling - creating new datasets from mean centred residuals of the original model fit - provides an alternative to case resampling.</li>
<li>Both resampling methods will be sensitive to the number of unique data points and the model being used.</li>
</ul>
<hr>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="co"># load packages</span>
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">boot</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">car</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">rTPC</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">nls.multstart</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">broom</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">tidyverse</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">patchwork</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">minpack.lm</span>)</pre></body></html></div>
</div>
<div id="case-resampling-resampling-the-original-data-with-replacement" class="section level1">
<h1 class="hasAnchor">
<a href="#case-resampling-resampling-the-original-data-with-replacement" class="anchor"></a>Case resampling: Resampling the original data with replacement</h1>
<p>Bootstrapping involves simulating “new” datasets produced from the existing data by sampling with replacement. The same model is then fitted separately on each individual bootstrapped dataset. Doing this over and over allows us to visualise uncertainty of predictions and produce confidence intervals of estimated parameters.</p>
<p>First, we will demonstrate this case resampling approach using data from a recent paper by Padfield <em>et al.</em> (2020), that measures the thermal performance of the bacteria, <em>Pseudomonas fluorescens</em>, in the presence and absence of its phage, <span class="math inline">\(\phi 2\)</span>. In this study, each single growth rate estimate is a technical replicate, coming from an isogenic strain of bacteria either inoculated with, or without, the phage. As such, all the data points within each phage treatment can be used to estimate the same curve. This becomes obvious as there is no <code>rep</code> column as in the <code>chlorella_tpc</code> dataset, but we can visualise one of the curves (bacteria in the absence of phage), using <strong>ggplot2</strong>.</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="co"># load in data</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span>(<span class="st">"bacteria_tpc"</span>)

<span class="co"># keep just a single curve</span>
<span class="no">d</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">bacteria_tpc</span>, <span class="no">phage</span> <span class="kw">==</span> <span class="st">'nophage'</span>)

<span class="co"># show the data</span>
<span class="fu">ggplot</span>(<span class="no">d</span>, <span class="fu">aes</span>(<span class="no">temp</span>, <span class="no">rate</span>)) +
  <span class="fu">geom_point</span>(<span class="kw">size</span> <span class="kw">=</span> <span class="fl">2</span>, <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.5</span>) +
  <span class="fu">theme_bw</span>(<span class="kw">base_size</span> <span class="kw">=</span> <span class="fl">12</span>) +
  <span class="fu">labs</span>(<span class="kw">x</span> <span class="kw">=</span> <span class="st">'Temperature (ºC)'</span>,
       <span class="kw">y</span> <span class="kw">=</span> <span class="st">'Growth rate'</span>,
       <span class="kw">title</span> <span class="kw">=</span> <span class="st">'Growth rate across temperatures'</span>)</pre></body></html></div>
<p><img src="bootstrapping_models_files/figure-html/load_data-1.png" width="576" style="display: block; margin: auto;"></p>
<p>As in the study, we can fit the Sharpe-Schoolfield model to the data and plot the predictions using the approaches in <code>vignette(rTPC)</code> and <code>vignette(fit_many_models)</code>.</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="co"># fit Sharpe-Schoolfield model</span>
<span class="no">d_fit</span> <span class="kw">&lt;-</span> <span class="fu">nest</span>(<span class="no">d</span>, <span class="kw">data</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">temp</span>, <span class="no">rate</span>)) <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="kw">sharpeschoolhigh</span> <span class="kw">=</span> <span class="fu">map</span>(<span class="no">data</span>, ~<span class="fu"><a href="https://rdrr.io/pkg/nls.multstart/man/nls_multstart.html">nls_multstart</a></span>(<span class="no">rate</span>~<span class="fu"><a href="../reference/sharpeschoolhigh_1981.html">sharpeschoolhigh_1981</a></span>(<span class="kw">temp</span> <span class="kw">=</span> <span class="no">temp</span>, <span class="no">r_tref</span>,<span class="no">e</span>,<span class="no">eh</span>,<span class="no">th</span>, <span class="kw">tref</span> <span class="kw">=</span> <span class="fl">15</span>),
                        <span class="kw">data</span> <span class="kw">=</span> <span class="no">.x</span>,
                        <span class="kw">iter</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">3</span>,<span class="fl">3</span>,<span class="fl">3</span>,<span class="fl">3</span>),
                        <span class="kw">start_lower</span> <span class="kw">=</span> <span class="fu"><a href="../reference/get_start_vals.html">get_start_vals</a></span>(<span class="no">.x</span>$<span class="no">temp</span>, <span class="no">.x</span>$<span class="no">rate</span>, <span class="kw">model_name</span> <span class="kw">=</span> <span class="st">'sharpeschoolhigh_1981'</span>) - <span class="fl">10</span>,
                        <span class="kw">start_upper</span> <span class="kw">=</span> <span class="fu"><a href="../reference/get_start_vals.html">get_start_vals</a></span>(<span class="no">.x</span>$<span class="no">temp</span>, <span class="no">.x</span>$<span class="no">rate</span>, <span class="kw">model_name</span> <span class="kw">=</span> <span class="st">'sharpeschoolhigh_1981'</span>) + <span class="fl">10</span>,
                        <span class="kw">lower</span> <span class="kw">=</span> <span class="fu"><a href="../reference/get_lower_lims.html">get_lower_lims</a></span>(<span class="no">.x</span>$<span class="no">temp</span>, <span class="no">.x</span>$<span class="no">rate</span>, <span class="kw">model_name</span> <span class="kw">=</span> <span class="st">'sharpeschoolhigh_1981'</span>),
                        <span class="kw">upper</span> <span class="kw">=</span> <span class="fu"><a href="../reference/get_upper_lims.html">get_upper_lims</a></span>(<span class="no">.x</span>$<span class="no">temp</span>, <span class="no">.x</span>$<span class="no">rate</span>, <span class="kw">model_name</span> <span class="kw">=</span> <span class="st">'sharpeschoolhigh_1981'</span>),
                        <span class="kw">supp_errors</span> <span class="kw">=</span> <span class="st">'Y'</span>,
                        <span class="kw">convergence_count</span> <span class="kw">=</span> <span class="fl">FALSE</span>)),
         <span class="co"># create new temperature data</span>
         <span class="kw">new_data</span> <span class="kw">=</span> <span class="fu">map</span>(<span class="no">data</span>, ~<span class="fu">tibble</span>(<span class="kw">temp</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="no">.x</span>$<span class="no">temp</span>), <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="no">.x</span>$<span class="no">temp</span>), <span class="kw">length.out</span> <span class="kw">=</span> <span class="fl">100</span>))),
         <span class="co"># predict over that data,</span>
         <span class="kw">preds</span> <span class="kw">=</span>  <span class="fu">map2</span>(<span class="no">sharpeschoolhigh</span>, <span class="no">new_data</span>, ~<span class="fu"><a href="https://broom.tidymodels.org/reference/reexports.html">augment</a></span>(<span class="no">.x</span>, <span class="kw">newdata</span> <span class="kw">=</span> <span class="no">.y</span>)))

<span class="co"># unnest predictions</span>
<span class="no">d_preds</span> <span class="kw">&lt;-</span> <span class="fu">select</span>(<span class="no">d_fit</span>, <span class="no">preds</span>) <span class="kw">%&gt;%</span>
  <span class="fu">unnest</span>(<span class="no">preds</span>)

<span class="co"># plot data and predictions</span>
<span class="fu">ggplot</span>() +
  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="no">temp</span>, <span class="no">.fitted</span>), <span class="no">d_preds</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="st">'blue'</span>) +
  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="no">temp</span>, <span class="no">rate</span>), <span class="no">d</span>, <span class="kw">size</span> <span class="kw">=</span> <span class="fl">2</span>, <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.5</span>) +
  <span class="fu">theme_bw</span>(<span class="kw">base_size</span> <span class="kw">=</span> <span class="fl">12</span>) +
  <span class="fu">labs</span>(<span class="kw">x</span> <span class="kw">=</span> <span class="st">'Temperature (ºC)'</span>,
       <span class="kw">y</span> <span class="kw">=</span> <span class="st">'Growth rate'</span>,
       <span class="kw">title</span> <span class="kw">=</span> <span class="st">'Growth rate across temperatures'</span>)</pre></body></html></div>
<p><img src="bootstrapping_models_files/figure-html/fit_and_plot-1.png" width="576" style="display: block; margin: auto;"> Here we have the best fit to the data. If we want confidence bands around this prediction, we can get those by resampling the data a number of times. The R package <strong>car</strong> has the function <strong>Boot</strong> that provides a wrapper for the widely used function <strong>boot::boot()</strong> that is tailored to bootstrapping regression models.</p>
<p>_nls_multstart()__ is designed to fit models across a wide possible parameter space, but because of it samples multiple start parameters for each model, using it with bootstrapping becomes computationally expensive. Instead, we refit the model using <strong>minpack.lm::nlsLM()</strong> and pass the coefficients from the previous model fit to be start values. The <strong>Boot</strong> function then refits the model 999 times and stores the model coefficients.</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="co"># refit model using nlsLM</span>
<span class="no">fit_nlsLM</span> <span class="kw">&lt;-</span> <span class="kw pkg">minpack.lm</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/minpack.lm/man/nlsLM.html">nlsLM</a></span>(<span class="no">rate</span>~<span class="fu"><a href="../reference/sharpeschoolhigh_1981.html">sharpeschoolhigh_1981</a></span>(<span class="kw">temp</span> <span class="kw">=</span> <span class="no">temp</span>, <span class="no">r_tref</span>,<span class="no">e</span>,<span class="no">eh</span>,<span class="no">th</span>, <span class="kw">tref</span> <span class="kw">=</span> <span class="fl">15</span>),
                        <span class="kw">data</span> <span class="kw">=</span> <span class="no">d</span>,
                        <span class="kw">start</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span>(<span class="no">d_fit</span>$<span class="no">sharpeschoolhigh</span><span class="kw">[[</span><span class="fl">1</span>]]),
                        <span class="kw">lower</span> <span class="kw">=</span> <span class="fu"><a href="../reference/get_lower_lims.html">get_lower_lims</a></span>(<span class="no">d</span>$<span class="no">temp</span>, <span class="no">d</span>$<span class="no">rate</span>, <span class="kw">model_name</span> <span class="kw">=</span> <span class="st">'sharpeschoolhigh_1981'</span>),
                        <span class="kw">upper</span> <span class="kw">=</span> <span class="fu"><a href="../reference/get_upper_lims.html">get_upper_lims</a></span>(<span class="no">d</span>$<span class="no">temp</span>, <span class="no">d</span>$<span class="no">rate</span>, <span class="kw">model_name</span> <span class="kw">=</span> <span class="st">'sharpeschoolhigh_1981'</span>))

<span class="co"># bootstrap using case resampling</span>
<span class="no">boot1</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/car/man/Boot.html">Boot</a></span>(<span class="no">fit_nlsLM</span>, <span class="kw">method</span> <span class="kw">=</span> <span class="st">'case'</span>)

<span class="co"># look at the data</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">boot1</span>$<span class="no">t</span>)
<span class="co">#&gt;         r_tref         e       eh       th</span>
<span class="co">#&gt; [1,] 0.2768424 0.6346997 2.600919 32.50854</span>
<span class="co">#&gt; [2,] 0.2886270 0.6895516 2.388658 31.36959</span>
<span class="co">#&gt; [3,] 0.2304775 1.0837795 2.377578 27.85005</span>
<span class="co">#&gt; [4,] 0.2211972 0.9318925 2.424346 29.75261</span>
<span class="co">#&gt; [5,] 0.2607113 0.8316133 2.418882 30.24069</span>
<span class="co">#&gt; [6,] 0.2564411 0.8869014 2.400021 29.73173</span></pre></body></html></div>
<p>The parameters of each bootstrapped refit are returned. We can easily create predictions for each of these models and then create confidence intervals around the original fitted predictions. We can then plot both some of the bootstrapped fits and the confidence regions around the model predictions.</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="co"># create predictions of each bootstrapped model</span>
<span class="no">boot1_preds</span> <span class="kw">&lt;-</span> <span class="no">boot1</span>$<span class="no">t</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu">drop_na</span>() <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="kw">iter</span> <span class="kw">=</span> <span class="fl">1</span>:<span class="fu">n</span>()) <span class="kw">%&gt;%</span>
  <span class="fu">group_by_all</span>() <span class="kw">%&gt;%</span>
  <span class="fu">do</span>(<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="kw">temp</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="no">d</span>$<span class="no">temp</span>), <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="no">d</span>$<span class="no">temp</span>), <span class="kw">length.out</span> <span class="kw">=</span> <span class="fl">100</span>))) <span class="kw">%&gt;%</span>
  <span class="fu">ungroup</span>() <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="kw">pred</span> <span class="kw">=</span> <span class="fu"><a href="../reference/sharpeschoolhigh_1981.html">sharpeschoolhigh_1981</a></span>(<span class="no">temp</span>, <span class="no">r_tref</span>, <span class="no">e</span>, <span class="no">eh</span>, <span class="no">th</span>, <span class="kw">tref</span> <span class="kw">=</span> <span class="fl">15</span>))

<span class="co"># calculate bootstrapped confidence intervals</span>
<span class="no">boot1_conf_preds</span> <span class="kw">&lt;-</span> <span class="fu">group_by</span>(<span class="no">boot1_preds</span>, <span class="no">temp</span>) <span class="kw">%&gt;%</span>
  <span class="fu">summarise</span>(<span class="kw">conf_lower</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span>(<span class="no">pred</span>, <span class="fl">0.025</span>),
            <span class="kw">conf_upper</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span>(<span class="no">pred</span>, <span class="fl">0.975</span>)) <span class="kw">%&gt;%</span>
  <span class="fu">ungroup</span>()

<span class="co"># plot bootstrapped CIs</span>
<span class="no">p1</span> <span class="kw">&lt;-</span> <span class="fu">ggplot</span>() +
  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="no">temp</span>, <span class="no">.fitted</span>), <span class="no">d_preds</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="st">'blue'</span>) +
  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="no">temp</span>, <span class="kw">ymin</span> <span class="kw">=</span> <span class="no">conf_lower</span>, <span class="kw">ymax</span> <span class="kw">=</span> <span class="no">conf_upper</span>), <span class="no">boot1_conf_preds</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="st">'blue'</span>, <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.3</span>) +
  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="no">temp</span>, <span class="no">rate</span>), <span class="no">d</span>, <span class="kw">size</span> <span class="kw">=</span> <span class="fl">2</span>, <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.5</span>) +
  <span class="fu">theme_bw</span>(<span class="kw">base_size</span> <span class="kw">=</span> <span class="fl">12</span>) +
  <span class="fu">labs</span>(<span class="kw">x</span> <span class="kw">=</span> <span class="st">'Temperature (ºC)'</span>,
       <span class="kw">y</span> <span class="kw">=</span> <span class="st">'Growth rate'</span>,
       <span class="kw">title</span> <span class="kw">=</span> <span class="st">'Growth rate across temperatures'</span>)

<span class="co"># plot bootstrapped predictions</span>
<span class="no">p2</span> <span class="kw">&lt;-</span> <span class="fu">ggplot</span>() +
  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="no">temp</span>, <span class="no">.fitted</span>), <span class="no">d_preds</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="st">'blue'</span>) +
  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="no">temp</span>, <span class="no">pred</span>, <span class="kw">group</span> <span class="kw">=</span> <span class="no">iter</span>), <span class="no">boot1_preds</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="st">'blue'</span>, <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.007</span>) +
  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="no">temp</span>, <span class="no">rate</span>), <span class="no">d</span>, <span class="kw">size</span> <span class="kw">=</span> <span class="fl">2</span>, <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.5</span>) +
  <span class="fu">theme_bw</span>(<span class="kw">base_size</span> <span class="kw">=</span> <span class="fl">12</span>) +
  <span class="fu">labs</span>(<span class="kw">x</span> <span class="kw">=</span> <span class="st">'Temperature (ºC)'</span>,
       <span class="kw">y</span> <span class="kw">=</span> <span class="st">'Growth rate'</span>,
       <span class="kw">title</span> <span class="kw">=</span> <span class="st">'Growth rate across temperatures'</span>)

<span class="no">p1</span> + <span class="no">p2</span></pre></body></html></div>
<p><img src="bootstrapping_models_files/figure-html/plot_boots-1.png" width="768" style="display: block; margin: auto;"></p>
<p>When there are many points beyond the optimum temperature and multiple points at each temperature, this method allows us to better quantify the uncertainty of out model fit.</p>
<p>This method becomes more problematic when there is a small sample size. It is common for thermal performance curves to have only one or two measurements beyond the optimum temperature. This means that many of the bootstrapped models will not have any points beyond the optimum, which is problematic for mathematical models that expect a unimodal shape. The effect of this can be seen by case resampling a curve from the <code>chlorella_tpc</code> dataset used throughout these vignettes. Here we again fit the model using <strong>nls_multstart()</strong>, refit the model using <strong>nlsLM()</strong>, then bootstrap the model using <strong>Boot()</strong>.</p>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="co"># load in chlorella data</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span>(<span class="st">'chlorella_tpc'</span>)

<span class="no">d2</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">chlorella_tpc</span>, <span class="no">curve_id</span> <span class="kw">==</span> <span class="fl">1</span>)

<span class="co"># fit Sharpe-Schoolfield model to raw data</span>
<span class="no">d_fit</span> <span class="kw">&lt;-</span> <span class="fu">nest</span>(<span class="no">d2</span>, <span class="kw">data</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">temp</span>, <span class="no">rate</span>)) <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="kw">sharpeschoolhigh</span> <span class="kw">=</span> <span class="fu">map</span>(<span class="no">data</span>, ~<span class="fu"><a href="https://rdrr.io/pkg/nls.multstart/man/nls_multstart.html">nls_multstart</a></span>(<span class="no">rate</span>~<span class="fu"><a href="../reference/sharpeschoolhigh_1981.html">sharpeschoolhigh_1981</a></span>(<span class="kw">temp</span> <span class="kw">=</span> <span class="no">temp</span>, <span class="no">r_tref</span>,<span class="no">e</span>,<span class="no">eh</span>,<span class="no">th</span>, <span class="kw">tref</span> <span class="kw">=</span> <span class="fl">15</span>),
                        <span class="kw">data</span> <span class="kw">=</span> <span class="no">.x</span>,
                        <span class="kw">iter</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">3</span>,<span class="fl">3</span>,<span class="fl">3</span>,<span class="fl">3</span>),
                        <span class="kw">start_lower</span> <span class="kw">=</span> <span class="fu"><a href="../reference/get_start_vals.html">get_start_vals</a></span>(<span class="no">.x</span>$<span class="no">temp</span>, <span class="no">.x</span>$<span class="no">rate</span>, <span class="kw">model_name</span> <span class="kw">=</span> <span class="st">'sharpeschoolhigh_1981'</span>) - <span class="fl">10</span>,
                        <span class="kw">start_upper</span> <span class="kw">=</span> <span class="fu"><a href="../reference/get_start_vals.html">get_start_vals</a></span>(<span class="no">.x</span>$<span class="no">temp</span>, <span class="no">.x</span>$<span class="no">rate</span>, <span class="kw">model_name</span> <span class="kw">=</span> <span class="st">'sharpeschoolhigh_1981'</span>) + <span class="fl">10</span>,
                        <span class="kw">lower</span> <span class="kw">=</span> <span class="fu"><a href="../reference/get_lower_lims.html">get_lower_lims</a></span>(<span class="no">.x</span>$<span class="no">temp</span>, <span class="no">.x</span>$<span class="no">rate</span>, <span class="kw">model_name</span> <span class="kw">=</span> <span class="st">'sharpeschoolhigh_1981'</span>),
                        <span class="kw">upper</span> <span class="kw">=</span> <span class="fu"><a href="../reference/get_upper_lims.html">get_upper_lims</a></span>(<span class="no">.x</span>$<span class="no">temp</span>, <span class="no">.x</span>$<span class="no">rate</span>, <span class="kw">model_name</span> <span class="kw">=</span> <span class="st">'sharpeschoolhigh_1981'</span>),
                        <span class="kw">supp_errors</span> <span class="kw">=</span> <span class="st">'Y'</span>,
                        <span class="kw">convergence_count</span> <span class="kw">=</span> <span class="fl">FALSE</span>)),
         <span class="co"># create new temperature data</span>
         <span class="kw">new_data</span> <span class="kw">=</span> <span class="fu">map</span>(<span class="no">data</span>, ~<span class="fu">tibble</span>(<span class="kw">temp</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="no">.x</span>$<span class="no">temp</span>), <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="no">.x</span>$<span class="no">temp</span>), <span class="kw">length.out</span> <span class="kw">=</span> <span class="fl">100</span>))),
         <span class="co"># predict over that data,</span>
         <span class="kw">preds</span> <span class="kw">=</span>  <span class="fu">map2</span>(<span class="no">sharpeschoolhigh</span>, <span class="no">new_data</span>, ~<span class="fu"><a href="https://broom.tidymodels.org/reference/reexports.html">augment</a></span>(<span class="no">.x</span>, <span class="kw">newdata</span> <span class="kw">=</span> <span class="no">.y</span>)))

<span class="co"># refit model using nlsLM</span>
<span class="no">fit_nlsLM2</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/minpack.lm/man/nlsLM.html">nlsLM</a></span>(<span class="no">rate</span>~<span class="fu"><a href="../reference/sharpeschoolhigh_1981.html">sharpeschoolhigh_1981</a></span>(<span class="kw">temp</span> <span class="kw">=</span> <span class="no">temp</span>, <span class="no">r_tref</span>,<span class="no">e</span>,<span class="no">eh</span>,<span class="no">th</span>, <span class="kw">tref</span> <span class="kw">=</span> <span class="fl">15</span>),
                        <span class="kw">data</span> <span class="kw">=</span> <span class="no">d2</span>,
                        <span class="kw">start</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span>(<span class="no">d_fit</span>$<span class="no">sharpeschoolhigh</span><span class="kw">[[</span><span class="fl">1</span>]]),
                        <span class="kw">lower</span> <span class="kw">=</span> <span class="fu"><a href="../reference/get_lower_lims.html">get_lower_lims</a></span>(<span class="no">d2</span>$<span class="no">temp</span>, <span class="no">d2</span>$<span class="no">rate</span>, <span class="kw">model_name</span> <span class="kw">=</span> <span class="st">'sharpeschoolhigh_1981'</span>),
                        <span class="kw">upper</span> <span class="kw">=</span> <span class="fu"><a href="../reference/get_upper_lims.html">get_upper_lims</a></span>(<span class="no">d2</span>$<span class="no">temp</span>, <span class="no">d2</span>$<span class="no">rate</span>, <span class="kw">model_name</span> <span class="kw">=</span> <span class="st">'sharpeschoolhigh_1981'</span>),
                        <span class="kw">control</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/minpack.lm/man/nls.lm.control.html">nls.lm.control</a></span>(<span class="kw">maxiter</span><span class="kw">=</span><span class="fl">500</span>))

<span class="co"># bootstrap using case resampling</span>
<span class="no">boot2</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/car/man/Boot.html">Boot</a></span>(<span class="no">fit_nlsLM2</span>, <span class="kw">method</span> <span class="kw">=</span> <span class="st">'case'</span>)
<span class="co">#&gt; </span>
<span class="co">#&gt;  Number of bootstraps was 991 out of 999 attempted</span></pre></body></html></div>
<pre><code>Number of bootstraps was 994 out of 999 attempted </code></pre>
<p>We can then create predictions for each bootstrapped model and calculate 95% confidence intervals around the predictions. Models that don’t fit and return <code>NA</code> for the parameter estimates are dropped.</p>
<div class="sourceCode" id="cb8"><html><body><pre class="r"><span class="co"># unnest predictions of original model fit</span>
<span class="no">d_preds</span> <span class="kw">&lt;-</span> <span class="fu">select</span>(<span class="no">d_fit</span>, <span class="no">preds</span>) <span class="kw">%&gt;%</span>
  <span class="fu">unnest</span>(<span class="no">preds</span>)

<span class="co"># predict over new data</span>
<span class="no">boot2_preds</span> <span class="kw">&lt;-</span> <span class="no">boot2</span>$<span class="no">t</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu">drop_na</span>() <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="kw">iter</span> <span class="kw">=</span> <span class="fl">1</span>:<span class="fu">n</span>()) <span class="kw">%&gt;%</span>
  <span class="fu">group_by_all</span>() <span class="kw">%&gt;%</span>
  <span class="fu">do</span>(<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="kw">temp</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="no">d2</span>$<span class="no">temp</span>), <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="no">d2</span>$<span class="no">temp</span>), <span class="kw">length.out</span> <span class="kw">=</span> <span class="fl">100</span>))) <span class="kw">%&gt;%</span>
  <span class="fu">ungroup</span>() <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="kw">pred</span> <span class="kw">=</span> <span class="fu"><a href="../reference/sharpeschoolhigh_1981.html">sharpeschoolhigh_1981</a></span>(<span class="no">temp</span>, <span class="no">r_tref</span>, <span class="no">e</span>, <span class="no">eh</span>, <span class="no">th</span>, <span class="kw">tref</span> <span class="kw">=</span> <span class="fl">15</span>))

<span class="co"># calculate bootstrapped confidence intervals</span>
<span class="no">boot2_conf_preds</span> <span class="kw">&lt;-</span> <span class="fu">group_by</span>(<span class="no">boot2_preds</span>, <span class="no">temp</span>) <span class="kw">%&gt;%</span>
  <span class="fu">summarise</span>(<span class="kw">conf_lower</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span>(<span class="no">pred</span>, <span class="fl">0.025</span>),
            <span class="kw">conf_upper</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span>(<span class="no">pred</span>, <span class="fl">0.975</span>)) <span class="kw">%&gt;%</span>
  <span class="fu">ungroup</span>()
<span class="co">#&gt; `summarise()` ungrouping output (override with `.groups` argument)</span>

<span class="co"># plot bootstrapped CIs</span>
<span class="no">p1</span> <span class="kw">&lt;-</span> <span class="fu">ggplot</span>() +
  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="no">temp</span>, <span class="no">.fitted</span>), <span class="no">d_preds</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="st">'blue'</span>) +
  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="no">temp</span>, <span class="kw">ymin</span> <span class="kw">=</span> <span class="no">conf_lower</span>, <span class="kw">ymax</span> <span class="kw">=</span> <span class="no">conf_upper</span>), <span class="no">boot2_conf_preds</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="st">'blue'</span>, <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.3</span>) +
  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="no">temp</span>, <span class="no">rate</span>), <span class="no">d2</span>, <span class="kw">size</span> <span class="kw">=</span> <span class="fl">2</span>, <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.5</span>) +
  <span class="fu">theme_bw</span>(<span class="kw">base_size</span> <span class="kw">=</span> <span class="fl">12</span>) +
  <span class="fu">labs</span>(<span class="kw">x</span> <span class="kw">=</span> <span class="st">'Temperature (ºC)'</span>,
       <span class="kw">y</span> <span class="kw">=</span> <span class="st">'Growth rate'</span>,
       <span class="kw">title</span> <span class="kw">=</span> <span class="st">'Growth rate across temperatures'</span>)

<span class="co"># plot bootstrapped predictions</span>
<span class="no">p2</span> <span class="kw">&lt;-</span> <span class="fu">ggplot</span>() +
  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="no">temp</span>, <span class="no">.fitted</span>), <span class="no">d_preds</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="st">'blue'</span>) +
  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="no">temp</span>, <span class="no">pred</span>, <span class="kw">group</span> <span class="kw">=</span> <span class="no">iter</span>), <span class="no">boot2_preds</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="st">'blue'</span>, <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.007</span>) +
  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="no">temp</span>, <span class="no">rate</span>), <span class="no">d2</span>, <span class="kw">size</span> <span class="kw">=</span> <span class="fl">2</span>, <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.5</span>) +
  <span class="fu">theme_bw</span>(<span class="kw">base_size</span> <span class="kw">=</span> <span class="fl">12</span>) +
  <span class="fu">labs</span>(<span class="kw">x</span> <span class="kw">=</span> <span class="st">'Temperature (ºC)'</span>,
       <span class="kw">y</span> <span class="kw">=</span> <span class="st">'Growth rate'</span>,
       <span class="kw">title</span> <span class="kw">=</span> <span class="st">'Growth rate across temperatures'</span>)

<span class="no">p1</span> + <span class="no">p2</span></pre></body></html></div>
<p><img src="bootstrapping_models_files/figure-html/bootstrap_case2_plot-1.png" width="768" style="display: block; margin: auto;"></p>
<p>As can be seen, bootstrapping-with-replacement with only a single point at each temperature can lead to a large variety of fits. In the second panel, we can see the variation of the curve fits, clustering around 4 possible paths for the decrease in rate beyond the optimum temperature. This is because in many instances there are no points sampled at the very high temperatures, leading to this clustering in curve fits. This is obviously not the ideal way of bootstrapping in such instances.</p>
</div>
<div id="residual-resampling" class="section level1">
<h1 class="hasAnchor">
<a href="#residual-resampling" class="anchor"></a>Residual resampling</h1>
<p>Case resampling is the most common way of thinking about bootstrapping. However, bootstrapping ordinary least squares regression models is often done using bootstrapping residuals. This method - where the values of the predictors in a study remain fixed during resampling - is especially useful in a designed experiment where the values of the predictors are set by the experimenter. This is commonly the case when measuring thermal performance curves.</p>
<p>Re-sampling residuals, at its heart, follows a simple set of steps:</p>
<ol style="list-style-type: decimal">
<li>Fit the model and for each data point, <span class="math inline">\(i\)</span>, retain the fitted values <span class="math inline">\(\hat{y_{i}}\)</span> and the residuals, <span class="math inline">\(\hat{e_{i}} = y_{i} - \hat{y_{i}}\)</span>
</li>
<li>For each data pair, (<span class="math inline">\(x_i\)</span>, <span class="math inline">\(y_i\)</span>), where <span class="math inline">\(x_i\)</span> is the measured temperature value, we add a randomly re-sampled residual, <span class="math inline">\(\hat{e}\)</span> to the fitted value <span class="math inline">\(\hat{y_i}\)</span>. This becomes the new <span class="math inline">\(y_i\)</span> value, such that <span class="math inline">\(y_i = \hat{y_i} + \hat{e}\)</span>. The new response variable is created based on the random re-allocation of the variation around the original model fit</li>
<li>The model is refit using the newly created <span class="math inline">\(y_i\)</span> response variable</li>
<li>Repeat steps 2 and 3 a number of times</li>
</ol>
<p>This method makes the assumption that the original model fit is a good representation of the data, and that the error terms in the model are normally distributed and independent. If the model is incorrectly specified – for example, if there is unmodelled non-linearity, non-constant error variance, or outliers – these characteristics will not carry over into the re-sampled data sets.</p>
<p><strong>car::Boot()</strong> has an argument that allows us to easily use residual resampling instead of case resampling..</p>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="co"># bootstrap using residual resampling</span>
<span class="no">boot3</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/car/man/Boot.html">Boot</a></span>(<span class="no">fit_nlsLM2</span>, <span class="kw">method</span> <span class="kw">=</span> <span class="st">'residual'</span>)

<span class="co"># predict over new data</span>
<span class="no">boot3_preds</span> <span class="kw">&lt;-</span> <span class="no">boot3</span>$<span class="no">t</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu">drop_na</span>() <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="kw">iter</span> <span class="kw">=</span> <span class="fl">1</span>:<span class="fu">n</span>()) <span class="kw">%&gt;%</span>
  <span class="fu">group_by_all</span>() <span class="kw">%&gt;%</span>
  <span class="fu">do</span>(<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="kw">temp</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="no">d2</span>$<span class="no">temp</span>), <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="no">d2</span>$<span class="no">temp</span>), <span class="kw">length.out</span> <span class="kw">=</span> <span class="fl">100</span>))) <span class="kw">%&gt;%</span>
  <span class="fu">ungroup</span>() <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="kw">pred</span> <span class="kw">=</span> <span class="fu"><a href="../reference/sharpeschoolhigh_1981.html">sharpeschoolhigh_1981</a></span>(<span class="no">temp</span>, <span class="no">r_tref</span>, <span class="no">e</span>, <span class="no">eh</span>, <span class="no">th</span>, <span class="kw">tref</span> <span class="kw">=</span> <span class="fl">15</span>))

<span class="co"># calculate bootstrapped confidence intervals</span>
<span class="no">boot3_conf_preds</span> <span class="kw">&lt;-</span> <span class="fu">group_by</span>(<span class="no">boot3_preds</span>, <span class="no">temp</span>) <span class="kw">%&gt;%</span>
  <span class="fu">summarise</span>(<span class="kw">conf_lower</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span>(<span class="no">pred</span>, <span class="fl">0.025</span>),
            <span class="kw">conf_upper</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span>(<span class="no">pred</span>, <span class="fl">0.975</span>)) <span class="kw">%&gt;%</span>
  <span class="fu">ungroup</span>()
<span class="co">#&gt; `summarise()` ungrouping output (override with `.groups` argument)</span>

<span class="co"># plot bootstrapped CIs</span>
<span class="no">p1</span> <span class="kw">&lt;-</span> <span class="fu">ggplot</span>() +
  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="no">temp</span>, <span class="no">.fitted</span>), <span class="no">d_preds</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="st">'blue'</span>) +
  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="no">temp</span>, <span class="kw">ymin</span> <span class="kw">=</span> <span class="no">conf_lower</span>, <span class="kw">ymax</span> <span class="kw">=</span> <span class="no">conf_upper</span>), <span class="no">boot3_conf_preds</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="st">'blue'</span>, <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.3</span>) +
  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="no">temp</span>, <span class="no">rate</span>), <span class="no">d2</span>, <span class="kw">size</span> <span class="kw">=</span> <span class="fl">2</span>) +
  <span class="fu">theme_bw</span>(<span class="kw">base_size</span> <span class="kw">=</span> <span class="fl">12</span>) +
  <span class="fu">labs</span>(<span class="kw">x</span> <span class="kw">=</span> <span class="st">'Temperature (ºC)'</span>,
       <span class="kw">y</span> <span class="kw">=</span> <span class="st">'Growth rate'</span>,
       <span class="kw">title</span> <span class="kw">=</span> <span class="st">'Growth rate across temperatures'</span>)

<span class="co"># plot bootstrapped predictions</span>
<span class="no">p2</span> <span class="kw">&lt;-</span> <span class="fu">ggplot</span>() +
  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="no">temp</span>, <span class="no">.fitted</span>), <span class="no">d_preds</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="st">'blue'</span>) +
  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="no">temp</span>, <span class="no">pred</span>, <span class="kw">group</span> <span class="kw">=</span> <span class="no">iter</span>), <span class="no">boot3_preds</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="st">'blue'</span>, <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.007</span>) +
  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="no">temp</span>, <span class="no">rate</span>), <span class="no">d2</span>, <span class="kw">size</span> <span class="kw">=</span> <span class="fl">2</span>) +
  <span class="fu">theme_bw</span>(<span class="kw">base_size</span> <span class="kw">=</span> <span class="fl">12</span>) +
  <span class="fu">labs</span>(<span class="kw">x</span> <span class="kw">=</span> <span class="st">'Temperature (ºC)'</span>,
       <span class="kw">y</span> <span class="kw">=</span> <span class="st">'Growth rate'</span>,
       <span class="kw">title</span> <span class="kw">=</span> <span class="st">'Growth rate across temperatures'</span>)

<span class="no">p1</span> + <span class="no">p2</span></pre></body></html></div>
<p><img src="bootstrapping_models_files/figure-html/residual_resample_data-1.png" width="768" style="display: block; margin: auto;"></p>
<p>This method seems to work a lot better, providing variation around the original curve fit without clustering around certain model fits.</p>
</div>
<div id="calculating-confidence-intervals-of-estimated-and-calculated-parameters" class="section level1">
<h1 class="hasAnchor">
<a href="#calculating-confidence-intervals-of-estimated-and-calculated-parameters" class="anchor"></a>Calculating confidence intervals of estimated and calculated parameters</h1>
<p>Bootstrapping can be used to estimate confidence intervals of the parameters explicitly modelled in the regression. We can compare this approach to profiled confidence intervals (using <strong>confint-MASS</strong>) and asymptotic confidence intervals (using <strong>nlstools::confint2()</strong>). We will do this on the two models done previously in this vignette. First with the bacteria TPC.</p>
<div class="sourceCode" id="cb10"><html><body><pre class="r"><span class="co"># First for the bacteria</span>

<span class="co"># get parameters of fitted model</span>
<span class="no">param_bact</span> <span class="kw">&lt;-</span> <span class="kw pkg">broom</span><span class="kw ns">::</span><span class="fu"><a href="https://broom.tidymodels.org/reference/reexports.html">tidy</a></span>(<span class="no">fit_nlsLM</span>) <span class="kw">%&gt;%</span>
  <span class="fu">select</span>(<span class="kw">param</span> <span class="kw">=</span> <span class="no">term</span>, <span class="no">estimate</span>)

<span class="co"># calculate confidence intervals of models</span>
<span class="no">ci_bact1</span> <span class="kw">&lt;-</span> <span class="kw pkg">nlstools</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/nlstools/man/confint2.html">confint2</a></span>(<span class="no">fit_nlsLM</span>, <span class="kw">method</span> <span class="kw">=</span> <span class="st">'asymptotic'</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu">rename</span>(<span class="kw">conf_lower</span> <span class="kw">=</span> <span class="fl">1</span>, <span class="kw">conf_upper</span> <span class="kw">=</span> <span class="fl">2</span>) <span class="kw">%&gt;%</span>
  <span class="fu">rownames_to_column</span>(<span class="no">.</span>, <span class="kw">var</span> <span class="kw">=</span> <span class="st">'param'</span>) <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="kw">method</span> <span class="kw">=</span> <span class="st">'asymptotic'</span>)
<span class="no">ci_bact2</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/confint.html">confint</a></span>(<span class="no">fit_nlsLM</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu">rename</span>(<span class="kw">conf_lower</span> <span class="kw">=</span> <span class="fl">1</span>, <span class="kw">conf_upper</span> <span class="kw">=</span> <span class="fl">2</span>) <span class="kw">%&gt;%</span>
  <span class="fu">rownames_to_column</span>(<span class="no">.</span>, <span class="kw">var</span> <span class="kw">=</span> <span class="st">'param'</span>) <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="kw">method</span> <span class="kw">=</span> <span class="st">'profile'</span>)
<span class="co">#&gt; Waiting for profiling to be done...</span>

<span class="co"># CIs from case resampling</span>
<span class="no">ci_bact3</span> <span class="kw">&lt;-</span> <span class="no">boot1</span>$<span class="no">t</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="kw">iter</span> <span class="kw">=</span> <span class="fl">1</span>:<span class="fu">n</span>()) <span class="kw">%&gt;%</span>
  <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> -<span class="no">iter</span>, <span class="kw">names_to</span> <span class="kw">=</span> <span class="st">'param'</span>, <span class="kw">values_to</span> <span class="kw">=</span> <span class="st">'estimate'</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(!<span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="no">estimate</span>)) <span class="kw">%&gt;%</span>
  <span class="fu">group_by</span>(<span class="no">param</span>) <span class="kw">%&gt;%</span>
  <span class="fu">summarise</span>(<span class="kw">conf_lower</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span>(<span class="no">estimate</span>, <span class="fl">0.025</span>),
            <span class="kw">conf_upper</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span>(<span class="no">estimate</span>, <span class="fl">0.975</span>),
            <span class="kw">.groups</span> <span class="kw">=</span> <span class="st">'drop'</span>) <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="kw">method</span> <span class="kw">=</span> <span class="st">'case bootstrap'</span>)

<span class="co"># CIs from residual resampling</span>
<span class="no">ci_bact4</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/car/man/Boot.html">Boot</a></span>(<span class="no">fit_nlsLM</span>, <span class="kw">method</span> <span class="kw">=</span> <span class="st">'residual'</span>) <span class="kw">%&gt;%</span>
  <span class="no">.</span>$<span class="no">t</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="kw">iter</span> <span class="kw">=</span> <span class="fl">1</span>:<span class="fu">n</span>()) <span class="kw">%&gt;%</span>
  <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> -<span class="no">iter</span>, <span class="kw">names_to</span> <span class="kw">=</span> <span class="st">'param'</span>, <span class="kw">values_to</span> <span class="kw">=</span> <span class="st">'estimate'</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(!<span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="no">estimate</span>)) <span class="kw">%&gt;%</span>
  <span class="fu">group_by</span>(<span class="no">param</span>) <span class="kw">%&gt;%</span>
  <span class="fu">summarise</span>(<span class="kw">conf_lower</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span>(<span class="no">estimate</span>, <span class="fl">0.025</span>),
            <span class="kw">conf_upper</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span>(<span class="no">estimate</span>, <span class="fl">0.975</span>),
            <span class="kw">.groups</span> <span class="kw">=</span> <span class="st">'drop'</span>) <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="kw">method</span> <span class="kw">=</span> <span class="st">'residual bootstrap'</span>)

<span class="no">ci_bact</span> <span class="kw">&lt;-</span> <span class="fu">bind_rows</span>(<span class="no">ci_bact1</span>, <span class="no">ci_bact2</span>, <span class="no">ci_bact3</span>, <span class="no">ci_bact4</span>) <span class="kw">%&gt;%</span>
  <span class="fu">left_join</span>(<span class="no">.</span>, <span class="no">param_bact</span>)
<span class="co">#&gt; Joining, by = "param"</span>

<span class="co"># plot</span>
<span class="fu">ggplot</span>(<span class="no">ci_bact</span>, <span class="fu">aes</span>(<span class="kw pkg">forcats</span><span class="kw ns">::</span><span class="fu"><a href="https://forcats.tidyverse.org/reference/fct_relevel.html">fct_relevel</a></span>(<span class="no">method</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'profile'</span>, <span class="st">'asymptotic'</span>)), <span class="no">estimate</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="no">method</span>)) +
  <span class="fu">geom_hline</span>(<span class="fu">aes</span>(<span class="kw">yintercept</span> <span class="kw">=</span> <span class="no">conf_lower</span>), <span class="kw">linetype</span> <span class="kw">=</span> <span class="fl">2</span>, <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">ci_bact</span>, <span class="no">method</span> <span class="kw">==</span> <span class="st">'profile'</span>)) +
  <span class="fu">geom_hline</span>(<span class="fu">aes</span>(<span class="kw">yintercept</span> <span class="kw">=</span> <span class="no">conf_upper</span>), <span class="kw">linetype</span> <span class="kw">=</span> <span class="fl">2</span>, <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">ci_bact</span>, <span class="no">method</span> <span class="kw">==</span> <span class="st">'profile'</span>)) +
  <span class="fu">geom_point</span>(<span class="kw">size</span> <span class="kw">=</span> <span class="fl">4</span>) +
  <span class="fu">geom_linerange</span>(<span class="fu">aes</span>(<span class="kw">ymin</span> <span class="kw">=</span> <span class="no">conf_lower</span>, <span class="kw">ymax</span> <span class="kw">=</span> <span class="no">conf_upper</span>)) +
  <span class="fu">theme_bw</span>() +
  <span class="fu">facet_wrap</span>(~<span class="no">param</span>, <span class="kw">scales</span> <span class="kw">=</span> <span class="st">'free'</span>) +
  <span class="fu">scale_x_discrete</span>(<span class="st">''</span>, <span class="kw">labels</span> <span class="kw">=</span> <span class="kw">function</span>(<span class="no">x</span>) <span class="kw pkg">stringr</span><span class="kw ns">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_wrap.html">str_wrap</a></span>(<span class="no">x</span>, <span class="kw">width</span> <span class="kw">=</span> <span class="fl">10</span>)) +
  <span class="fu">labs</span>(<span class="kw">title</span> <span class="kw">=</span> <span class="st">'Calculation of confidence intervals for model parameters'</span>,
       <span class="kw">subtitle</span> <span class="kw">=</span> <span class="st">'For the bacteria TPC; dashed lines are CI of profiling method'</span>)</pre></body></html></div>
<p><img src="bootstrapping_models_files/figure-html/confint_bact-1.png" width="672" style="display: block; margin: auto;"></p>
<p>The dashed lines represent the 95% intervals for the profiling method. The different bootstrap methods do a reasonable job at being close to these intervals, but not all parameters are the same. For example, <code>r_tref</code> and <code>e</code> give wider (and asymmetric) confidence intervals using the case resampling method. The residual method gives estimates that are closer to the ones calculated from profiling.</p>
<p>Now for the TPC from the <em>Chlorella</em> dataset.</p>
<div class="sourceCode" id="cb11"><html><body><pre class="r"><span class="co"># Second for Chlorella data</span>

<span class="co"># get parameters of fitted model</span>
<span class="no">param_chlor</span> <span class="kw">&lt;-</span> <span class="kw pkg">broom</span><span class="kw ns">::</span><span class="fu"><a href="https://broom.tidymodels.org/reference/reexports.html">tidy</a></span>(<span class="no">fit_nlsLM2</span>) <span class="kw">%&gt;%</span>
  <span class="fu">select</span>(<span class="kw">param</span> <span class="kw">=</span> <span class="no">term</span>, <span class="no">estimate</span>)

<span class="co"># calculate confidence intervals of models</span>
<span class="no">ci_chlor1</span> <span class="kw">&lt;-</span> <span class="kw pkg">nlstools</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/nlstools/man/confint2.html">confint2</a></span>(<span class="no">fit_nlsLM2</span>, <span class="kw">method</span> <span class="kw">=</span> <span class="st">'asymptotic'</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu">rename</span>(<span class="kw">conf_lower</span> <span class="kw">=</span> <span class="fl">1</span>, <span class="kw">conf_upper</span> <span class="kw">=</span> <span class="fl">2</span>) <span class="kw">%&gt;%</span>
  <span class="fu">rownames_to_column</span>(<span class="no">.</span>, <span class="kw">var</span> <span class="kw">=</span> <span class="st">'param'</span>) <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="kw">method</span> <span class="kw">=</span> <span class="st">'asymptotic'</span>)
<span class="no">ci_chlor2</span> <span class="kw">&lt;-</span> <span class="kw pkg">nlstools</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/nlstools/man/confint2.html">confint2</a></span>(<span class="no">fit_nlsLM2</span>, <span class="kw">method</span> <span class="kw">=</span> <span class="st">'profile'</span>)
<span class="co">#&gt; Waiting for profiling to be done...</span>
<span class="co">#&gt; Error in prof$getProfile(): number of iterations exceeded maximum of 50</span>
<span class="co"># profiling method fails</span>
<span class="no">ci_chlor2</span> <span class="kw">&lt;-</span> <span class="fu">mutate</span>(<span class="no">ci_chlor1</span>, <span class="kw">method</span> <span class="kw">=</span> <span class="st">'profile'</span>,
                    <span class="kw">conf_lower</span> <span class="kw">=</span> <span class="fl">NA</span>,
                    <span class="kw">conf_upper</span> <span class="kw">=</span> <span class="fl">NA</span>)

<span class="co"># CIs from case resampling</span>
<span class="no">ci_chlor3</span> <span class="kw">&lt;-</span> <span class="no">boot2</span>$<span class="no">t</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="kw">iter</span> <span class="kw">=</span> <span class="fl">1</span>:<span class="fu">n</span>()) <span class="kw">%&gt;%</span>
  <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> -<span class="no">iter</span>, <span class="kw">names_to</span> <span class="kw">=</span> <span class="st">'param'</span>, <span class="kw">values_to</span> <span class="kw">=</span> <span class="st">'estimate'</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(!<span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="no">estimate</span>)) <span class="kw">%&gt;%</span>
  <span class="fu">group_by</span>(<span class="no">param</span>) <span class="kw">%&gt;%</span>
  <span class="fu">summarise</span>(<span class="kw">conf_lower</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span>(<span class="no">estimate</span>, <span class="fl">0.025</span>),
            <span class="kw">conf_upper</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span>(<span class="no">estimate</span>, <span class="fl">0.975</span>),
            <span class="kw">.groups</span> <span class="kw">=</span> <span class="st">'drop'</span>) <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="kw">method</span> <span class="kw">=</span> <span class="st">'case bootstrap'</span>)

<span class="co"># CIs from residual resampling</span>
<span class="no">ci_chlor4</span> <span class="kw">&lt;-</span> <span class="no">boot3</span>$<span class="no">t</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="kw">iter</span> <span class="kw">=</span> <span class="fl">1</span>:<span class="fu">n</span>()) <span class="kw">%&gt;%</span>
  <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> -<span class="no">iter</span>, <span class="kw">names_to</span> <span class="kw">=</span> <span class="st">'param'</span>, <span class="kw">values_to</span> <span class="kw">=</span> <span class="st">'estimate'</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(!<span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="no">estimate</span>)) <span class="kw">%&gt;%</span>
  <span class="fu">group_by</span>(<span class="no">param</span>) <span class="kw">%&gt;%</span>
  <span class="fu">summarise</span>(<span class="kw">conf_lower</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span>(<span class="no">estimate</span>, <span class="fl">0.025</span>),
            <span class="kw">conf_upper</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span>(<span class="no">estimate</span>, <span class="fl">0.975</span>),
            <span class="kw">.groups</span> <span class="kw">=</span> <span class="st">'drop'</span>) <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="kw">method</span> <span class="kw">=</span> <span class="st">'residual bootstrap'</span>)

<span class="no">ci_chlor</span> <span class="kw">&lt;-</span> <span class="fu">bind_rows</span>(<span class="no">ci_chlor1</span>, <span class="no">ci_chlor2</span>, <span class="no">ci_chlor3</span>, <span class="no">ci_chlor4</span>) <span class="kw">%&gt;%</span>
  <span class="fu">full_join</span>(<span class="no">.</span>, <span class="no">param_chlor</span>)
<span class="co">#&gt; Joining, by = "param"</span>

<span class="fu">ggplot</span>(<span class="no">ci_chlor</span>, <span class="fu">aes</span>(<span class="kw pkg">forcats</span><span class="kw ns">::</span><span class="fu"><a href="https://forcats.tidyverse.org/reference/fct_relevel.html">fct_relevel</a></span>(<span class="no">method</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'profile'</span>, <span class="st">'asymptotic'</span>)), <span class="no">estimate</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="no">method</span>)) +
  <span class="fu">geom_point</span>(<span class="kw">size</span> <span class="kw">=</span> <span class="fl">4</span>) +
  <span class="fu">geom_linerange</span>(<span class="fu">aes</span>(<span class="kw">ymin</span> <span class="kw">=</span> <span class="no">conf_lower</span>, <span class="kw">ymax</span> <span class="kw">=</span> <span class="no">conf_upper</span>)) +
  <span class="fu">theme_bw</span>() +
  <span class="fu">facet_wrap</span>(~<span class="no">param</span>, <span class="kw">scales</span> <span class="kw">=</span> <span class="st">'free'</span>) +
  <span class="fu">scale_x_discrete</span>(<span class="st">''</span>, <span class="kw">labels</span> <span class="kw">=</span> <span class="kw">function</span>(<span class="no">x</span>) <span class="kw pkg">stringr</span><span class="kw ns">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_wrap.html">str_wrap</a></span>(<span class="no">x</span>, <span class="kw">width</span> <span class="kw">=</span> <span class="fl">10</span>)) +
  <span class="fu">labs</span>(<span class="kw">title</span> <span class="kw">=</span> <span class="st">'Calculation of confidence intervals for model parameters'</span>,
       <span class="kw">subtitle</span> <span class="kw">=</span> <span class="st">'For the chlorella TPC; profile method failes'</span>)</pre></body></html></div>
<p><img src="bootstrapping_models_files/figure-html/confint_chlor-1.png" width="672" style="display: block; margin: auto;"> For this curve, the profiling method failed and the asymptotic method has very wide confidence intervals for <code>eh</code>. Consequently, it is hard to know how the bootstrapping methods do as these would usually be benchmarked against the profiling method. Even so, we can see that the intervals for <code>eh</code> and <code>th</code> for the case resampling method are very wide (as can be seen from the plot of the model predictions earlier). Meanwhile, the residual resampling method again gives more symmetric estimates, but we don’t know if they are conservative which would increase the rate of false positives if used for inference.</p>
<p>We can also bootstrap confidence intervals for the extra parameters calculated in <strong>calc_params()</strong>. We will do this for the bacteria TPC and the case resample.</p>
<div class="sourceCode" id="cb12"><html><body><pre class="r"><span class="no">extra_params</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/calc_params.html">calc_params</a></span>(<span class="no">fit_nlsLM</span>) <span class="kw">%&gt;%</span>
  <span class="fu">pivot_longer</span>(<span class="fu">everything</span>(), <span class="kw">names_to</span> <span class="kw">=</span>  <span class="st">'param'</span>, <span class="kw">values_to</span> <span class="kw">=</span> <span class="st">'estimate'</span>)

<span class="no">ci_extra_params</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/car/man/Boot.html">Boot</a></span>(<span class="no">fit_nlsLM</span>, <span class="kw">f</span> <span class="kw">=</span> <span class="kw">function</span>(<span class="no">x</span>){<span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span>(<span class="fu"><a href="../reference/calc_params.html">calc_params</a></span>(<span class="no">x</span>))}, <span class="kw">labels</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="fu"><a href="../reference/calc_params.html">calc_params</a></span>(<span class="no">fit_nlsLM</span>)), <span class="kw">R</span> <span class="kw">=</span> <span class="fl">200</span>, <span class="kw">method</span> <span class="kw">=</span> <span class="st">'case'</span>) <span class="kw">%&gt;%</span>
  <span class="no">.</span>$<span class="no">t</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="kw">iter</span> <span class="kw">=</span> <span class="fl">1</span>:<span class="fu">n</span>()) <span class="kw">%&gt;%</span>
  <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> -<span class="no">iter</span>, <span class="kw">names_to</span> <span class="kw">=</span> <span class="st">'param'</span>, <span class="kw">values_to</span> <span class="kw">=</span> <span class="st">'estimate'</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(!<span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="no">estimate</span>)) <span class="kw">%&gt;%</span>
  <span class="fu">group_by</span>(<span class="no">param</span>) <span class="kw">%&gt;%</span>
  <span class="fu">summarise</span>(<span class="kw">conf_lower</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span>(<span class="no">estimate</span>, <span class="fl">0.025</span>),
            <span class="kw">conf_upper</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span>(<span class="no">estimate</span>, <span class="fl">0.975</span>),
            <span class="kw">.groups</span> <span class="kw">=</span> <span class="st">'drop'</span>)

<span class="no">ci_extra_params</span> <span class="kw">&lt;-</span> <span class="fu">left_join</span>(<span class="no">ci_extra_params</span>, <span class="no">extra_params</span>)
<span class="co">#&gt; Joining, by = "param"</span>

<span class="fu">ggplot</span>(<span class="no">ci_extra_params</span>, <span class="fu">aes</span>(<span class="no">param</span>, <span class="no">estimate</span>)) +
  <span class="fu">geom_point</span>(<span class="kw">size</span> <span class="kw">=</span> <span class="fl">4</span>) +
  <span class="fu">geom_linerange</span>(<span class="fu">aes</span>(<span class="kw">ymin</span> <span class="kw">=</span> <span class="no">conf_lower</span>, <span class="kw">ymax</span> <span class="kw">=</span> <span class="no">conf_upper</span>)) +
  <span class="fu">theme_bw</span>() +
  <span class="fu">facet_wrap</span>(~<span class="no">param</span>, <span class="kw">scales</span> <span class="kw">=</span> <span class="st">'free'</span>) +
  <span class="fu">scale_x_discrete</span>(<span class="st">''</span>) +
  <span class="fu">labs</span>(<span class="kw">title</span> <span class="kw">=</span> <span class="st">'Calculation of confidence intervals for extra parameters'</span>,
       <span class="kw">subtitle</span> <span class="kw">=</span> <span class="st">'For the bacteria TPC; using case resampling'</span>)</pre></body></html></div>
<p><img src="bootstrapping_models_files/figure-html/ci_calc_param-1.png" width="672" style="display: block; margin: auto;"> You can see that the confidence intervals around certain parameters, such as <code>e</code>, <code>eh</code>, <code>q10</code>, and <code>skewness</code> are very asymmetrical. This is because they are modelled from a subsample of the original dataset (for example, <code>e</code> is calculated from fitting a modified Boltzmann equation to all the points at or below the optimum temperature as calculated from the model predictions). If interested in these parameters, we recommend using mathematical models that contain them explicitly in the formulation.</p>
<hr>
<p>NB The Padfield _et al.__ analysis actually uses a Bayesian approach to fit thermal performance curves, quantify uncertainty, and estimate derived parameters. This approach is powerful and flexible, and becoming easier to use with the incredible development of the R package <a href="https://github.com/paul-buerkner/brms"><strong>brms</strong></a>. Examples of using <strong>brms</strong> to model thermal performance curves can be found on the <a href="https://github.com/padpadpadpad/Padfield_2019_ISME_bact_phage_temperature">GitHub repository</a> of the paper</p>
<hr>
<div id="further-reading" class="section level4">
<h4 class="hasAnchor">
<a href="#further-reading" class="anchor"></a>Further reading</h4>
<ul>
<li>John Fox (author of car) on bootstrapping regression models in R
<ul>
<li><a href="https://statweb.stanford.edu/~owen/courses/305a/FoxOnBootingRegInR.pdf" class="uri">https://statweb.stanford.edu/~owen/courses/305a/FoxOnBootingRegInR.pdf</a></li>
</ul>
</li>
<li>A.C. Davison &amp; D.V. Hinkley (2003) Bootstrap Methods and their Application. - <a href="https://www.cambridge.org/core/books/bootstrap-methods-and-their-application/ED2FD043579F27952363566DC09CBD6A" class="uri">https://www.cambridge.org/core/books/bootstrap-methods-and-their-application/ED2FD043579F27952363566DC09CBD6A</a>
</li>
</ul>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Daniel Padfield, Hannah O'Sullivan.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
